<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dise√±o PK</title>
<!-- Fuente moderna -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
    :root{
        --bg-1: #f8fafc; /* claro */
        --bg-2: #f1f5f9;
        --card: rgba(0,0,0,0.02);
        --muted: #64748b;
        --accent: #34d399; /* verde */
        --accent2: #3b82f6; /* azul */
        --warning: #e74c3c;
        --glass: rgba(255,255,255,0.8);
        --glass-border: rgba(0,0,0,0.08);
        --glass-text: rgba(15,23,42,0.94);
        /* Tama√±os de botones principales (f√°cil de personalizar) */
        --top-btn-height: 64px; /* altura por defecto */
        --top-btn-max-width: 360px; /* anchura m√°xima por bot√≥n */
        --top-btn-font-size: 14px; /* tama√±o de la tipograf√≠a dentro del bot√≥n */
    }
    html,body{height:100%;margin:0;}
    /* Ocultar barras de scroll - navegaci√≥n solo con mouse */
    ::-webkit-scrollbar { display:none; }
    html { -ms-overflow-style:none; scrollbar-width:none; }
    /* ligera escala global para que la interfaz quepa mejor en pantallas grandes */
    body {
        transform: scale(1);
        transform-origin: top center;
        -webkit-transform: scale(1);
        -webkit-transform-origin: top center;
        font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 12px;
        padding: 8px; /* usar menos padding para aprovechar espacios laterales */
        background: linear-gradient(135deg, var(--bg-1) 0%, var(--bg-2) 100%);
        color: var(--glass-text);
    }
    /* stage */
    .container {
        display: flex;
        gap: 12px; /* un poco m√°s de separaci√≥n entre columnas para claridad */
        border-radius: 12px;
        padding: 12px 8px; /* menos padding para reducir tama√±o total */
        background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.85));
        box-shadow: 0 20px 40px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.8);
        max-width: 100%;
        width: 100%;
        border: 1px solid rgba(0,0,0,0.06);
        justify-content: space-between;
        flex-wrap: nowrap;
    }
    .column {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 2px;
        /* Distribuir columnas usando todo el ancho disponible */
        flex: 1 1 0;        /* columnas crecen y se comprimen para usar el ancho */
        min-width: 140px;  /* evita columnas demasiado estrechas */
        max-width: 360px;  /* limitar ancho para columnas grandes */
        background: linear-gradient(180deg, rgba(255,255,255,0.5), rgba(255,255,255,0.3));
        padding: 8px 6px 9px;
        border-radius: 8px;
        border: 1px solid rgba(0,0,0,0.06);
        position: relative;
        transition: transform 220ms ease, box-shadow 220ms ease;
        flex-shrink: 0;
    }
    .column:hover{ transform: translateY(-4px); box-shadow: 0 14px 30px rgba(0,0,0,0.1); }
    .column-header {
        font-weight: 700;
        text-align: center;
        margin-bottom: 9px;
        color: var(--glass-text);
        background: linear-gradient(90deg, rgba(0,0,0,0.03), rgba(0,0,0,0.02));
        padding: 4px 6px;
        border-radius: 6px;
        width: 100%;
        box-shadow: inset 0 -6px 18px rgba(0,0,0,0.02);
        font-size: 18px;
        letter-spacing: 0.5px;
    }
    .column .sol-timer{
        font-size: 12px;
        color: #06364a;
        margin-top: 6px;
        font-weight: 800;
        text-align: center;
        background: rgba(255,255,255,0.9);
        padding: 4px 6px;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(2,6,23,0.06);
        min-width: 80px;
        margin-left: auto;
        margin-right: auto;
    }
    /* cabecera NO clickable: selecci√≥n por t√≠tulo deshabilitada */
    .column-header {
        cursor: default;
        user-select: none;
        pointer-events: auto; /* keep pointer events for future features but prevent click-to-select behavior */
    }
    .block {
        width: 86%; /* ocupar la mayor parte del ancho de la columna */
        max-width: 240px; /* limitar ancho m√°ximo para no crecer demasiado */
        height: 64px; /* un poco m√°s alto para mejor lectura */
        display: flex; /* centrar contenido */
        align-items: center;
        justify-content: center;
        padding: 0 10px; /* espacio lateral para evitar overflow */
        background: linear-gradient(180deg,#fff85a,#fff069 60%);
        border-radius: 6px;
        border: 1px solid rgba(0,0,0,0.14);
        margin: 8px 0;
        box-shadow: 0 6px 14px rgba(3,7,18,0.12), inset 0 -6px 18px rgba(255,255,255,0.35);
        transition: transform 180ms ease, opacity 160ms ease;
    }
    .block .label{ display:block; font-size:18px; text-align:center; margin:0; color:#0b1220; font-weight:800; pointer-events:none; 
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
    /* selecci√≥n de parcial (click) */
    .block.selected-parcial{
        outline: 3px solid rgba(59,130,246,0.95);
        box-shadow: 0 10px 30px rgba(59,130,246,0.18), inset 0 -4px 10px rgba(255,255,255,0.4);
        transform: translateY(-3px);
    }
    /* parcial en estado 'solicitado' ‚Äî titilar */
    @keyframes blink-partial {
        0% {
            box-shadow: 0 12px 28px rgba(34,197,94,0.40), 0 0 0 0 rgba(34,197,94,0);
            border-color: rgba(34,197,94,0.98);
            transform: translateY(-2px) scale(1);
            background: linear-gradient(180deg,#34d399,#10b981);
        }
        25% {
            box-shadow: 0 18px 44px rgba(231,76,60,0.48), 0 0 10px rgba(231,76,60,0.26);
            border-color: rgba(231,76,60,0.99);
            transform: translateY(-3px) scale(1.03);
            background: linear-gradient(180deg,#f87171,#ef4444);
        }
        50% {
            box-shadow: 0 14px 36px rgba(250,204,21,0.44), 0 0 10px rgba(250,204,21,0.24);
            border-color: rgba(250,204,21,0.99);
            transform: translateY(-2px) scale(1.02);
            background: linear-gradient(180deg,#fff85a,#fff069 60%);
        }
        75% {
            box-shadow: 0 18px 44px rgba(231,76,60,0.48), 0 0 14px rgba(231,76,60,0.26);
            border-color: rgba(231,76,60,0.99);
            transform: translateY(-3px) scale(1.03);
            background: linear-gradient(180deg,#f87171,#ef4444);
        }
        100% {
            box-shadow: 0 12px 28px rgba(34,197,94,0.40), 0 0 0 0 rgba(34,197,94,0);
            border-color: rgba(34,197,94,0.98);
            transform: translateY(-2px) scale(1);
            background: linear-gradient(180deg,#34d399,#10b981);
        }
    }
    .block.requested{
        animation: blink-partial 1.2s linear infinite;
        border-width: 2px;
        border-style: solid;
        z-index: 6;
        color: #0b1220;
        /* asegurar que el texto (si existe) sea visible sobre fondos cambiantes */
    }
    .block.appear{ animation: pop 320ms cubic-bezier(.2,.9,.3,1); }
    .block.removing{ animation: fadeOut 220ms ease forwards; }
    @keyframes pop{ 0%{ transform: scale(.86); opacity:0 } 60%{ transform: scale(1.04); opacity:1 } 100%{ transform: scale(1); } }
    @keyframes fadeOut{ to { transform: scale(.94); opacity:0 } }
    /* contenedor principal: layout vertical con botones arriba */
    .main-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
        max-width: none; /* permitir que ocupe todo el ancho disponible */
    }
    /* fila superior: botones */
    .top-controls {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr; /* volver a 3 columnas para no cambiar ubicaci√≥n de botones */
        grid-template-rows: auto auto;
        gap: 24px 300px; /* aumentado espacio horizontal entre botones */
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
        padding: 6px 0 0 0;
        position: sticky;
        top: 18px;
        z-index: 90;
        background: transparent;
    }
    
    /* Posicionamiento de botones en grid */
    #btn-anular-solicitud {
        grid-column: 3;
        grid-row: 1;
    }
    
    #btn-entrada {
        grid-column: 1;
        grid-row: 2;
    }
    
    #btn-salida {
        grid-column: 2;
        grid-row: 2;
    }
    
    #btn-solicitar {
        grid-column: 3;
        grid-row: 2;
    }
    /* contenedor inferior: b√∫squeda izq, l√≠neas der */
    .bottom-container {
        display: flex;
        gap: 12px;
        width: 100%;
        flex: 1;
    }
    /* panel izquierdo abajo: b√∫squeda y gestionar (m√°s angosto) */
    .controls {
        border-radius: 12px;
        padding: 8px 10px;
        background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.85));
        width: 240px; /* reducir ancho para ceder espacio a las columnas */
        min-width: 200px;
        border: 1px solid rgba(0,0,0,0.06);
        backdrop-filter: blur(6px) saturate(120%);
        box-shadow: 0 12px 30px rgba(0,0,0,0.08);
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
        box-sizing: border-box; /* ensure padding included in width */
        overflow: hidden; /* keep children visually inside the panel */
    }

    /* Ocultar el panel izquierdo para aprovechar todo el ancho disponible */
    .controls{ display:none !important; width:0 !important; min-width:0 !important; padding:0 !important; margin:0 !important }
        /* floating top-left actions (visual style) */
        .floating-actions{ position: fixed; left: 18px; top: 18px; display:flex; flex-direction:column; gap:10px; z-index:120 }
        /* Botones flotantes: m√°s grandes y dispositivos amigables */
        .floating-actions button{
            min-width:110px;           /* anchura m√≠nima reducida */
            width:auto;
            height:40px;               /* altura reducida */
            padding:6px 10px;          /* menos padding */
            border-radius:10px;
            border:none;
            font-weight:600;
            color:white;
            background: linear-gradient(90deg,#3b82f6,#2563eb);
            box-shadow: 0 8px 18px rgba(37,99,235,0.12);
            cursor:pointer;
            transition: transform 120ms ease, box-shadow 120ms ease;
            display:flex;
            align-items:center;
            justify-content:center;
            text-align:center;
            white-space:normal;
            line-height:1.05;
            font-size:13px;            /* tama√±o de texto reducido */
        }
        .floating-actions button:hover{ transform: translateY(-3px); box-shadow: 0 16px 36px rgba(37,99,235,0.16); }
        /* make export button same color / look as manage button */
        .floating-actions .export-btn{ background: linear-gradient(90deg,#3b82f6,#2563eb); }
        @media (max-width:900px){
            .floating-actions{ position: static; margin-bottom:12px; display:flex; flex-direction:row; gap:8px }
            .floating-actions button{ width:auto; min-width:110px; height:48px; font-size:13px }
        }

        /* responsive for top-controls: keep compact info usable on small screens */
        @media (max-width:900px){
            .top-controls{ grid-template-columns: repeat(2,1fr); gap:12px 12px }
        }

        /* floating history card (moved m√°s a la derecha para separar de los botones) */
          /* hacer el panel un poco m√°s peque√±o y desplazado ligeramente hacia la derecha
              para que no se superponga con el bot√≥n "ABASTECER KAMBAN" */
        /* con el panel lateral eliminado, acercamos el hist√≥rico al borde izquierdo */
        /* Position floating history to the right of the action buttons (avoid overlapping controls) */
        .floating-history{ position: fixed; left: calc(200px + 180px); top: 120px; width: 320px; z-index:115; }
        .floating-history .history-controls{ display:flex; gap:6px; align-items:center; justify-content:space-between; margin-bottom:6px }
        .floating-history .drag-handle{ width:34px; height:34px; border-radius:8px; border:0; background: rgba(11,18,32,0.06); cursor:grab; display:inline-flex; align-items:center; justify-content:center; font-weight:800; color: var(--glass-text); }
        .floating-history .drag-handle:active{ cursor:grabbing }
        .floating-history .history-reset{ width:34px; height:34px; border-radius:8px; border:0; background: rgba(11,18,32,0.04); cursor:pointer; display:inline-flex; align-items:center; justify-content:center; font-size:14px }
        .floating-history.dragging { opacity:0.96; transform: none; transition: none }
        .floating-history .history-card{ padding:12px; border-radius:12px; box-shadow: 0 18px 48px rgba(2,6,23,0.08); border:1px solid rgba(0,0,0,0.04); background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(250,250,250,0.96)); }
        .floating-history .search-row{ display:flex; gap:8px; align-items:center; }
        .floating-history .search-input{ width:100%; }
        .floating-history .search-clear{ padding:6px;border-radius:8px }
        /* mostrar exactamente 1 tarjeta del historial (ni m√°s ni menos) */
        /* Elegimos una altura fija de tarjeta que contiene: t√≠tulo, l√≠nea, solicitud, entrega y tiempo */
        #recent-history-list{
            list-style:none;
            padding:0;           /* quitar padding para que la tarjeta encaje exactamente */
            margin:0;
            height:150px;       /* reducir un poco la altura para evitar solapamiento con el bot√≥n */
            overflow-y:auto;    /* permitir desplazamiento con botones o rueda */
            scroll-snap-type: y mandatory; /* snap por tarjeta */
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            position:relative;
        }
        /* ocultar scrollbar visual (mantener funcionalidad) */
        #recent-history-list::-webkit-scrollbar{ width:8px; height:8px }
        #recent-history-list::-webkit-scrollbar-thumb{ background: rgba(0,0,0,0.12); border-radius:8px }
        #recent-history-list::-webkit-scrollbar-track{ background:transparent }
        /* centrar verticalmente los botones de navegaci√≥n respecto a la tarjeta visible */
        #recent-history .recent-nav{ position:absolute; right:8px; top:50%; transform:translateY(-50%); display:none; flex-direction:column; gap:6px; z-index:130 }
        #recent-history .recent-nav button{ width:34px; height:34px; border-radius:8px; border:0; background: rgba(11,18,32,0.06); cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:800; color: var(--glass-text); }
        #recent-history .recent-nav button:hover{ background: rgba(11,18,32,0.10); transform: translateY(-2px); }
        @media (max-width:900px){ .floating-history{ position: static; margin: 8px 0 12px 0; width: auto; left: auto } }

        /* estilo por defecto para los items de historial: tarjeta con altura fija que encaja exactamente en el contenedor */
        #recent-history-list li{
            background: linear-gradient(180deg,#ffffff,#fbfdff);
            border-radius:10px;
            padding:12px 14px;
            margin:0; /* sin margen para que cada li ocupe exactamente la altura del contenedor */
            box-shadow: 0 8px 22px rgba(2,6,23,0.06);
            border-left: 4px solid rgba(59,130,246,0.06);
            box-sizing: border-box;
            height: 150px;      /* cada li tendr√° EXACTAMENTE la misma altura que el contenedor */
            overflow: hidden;   /* ocultar cualquier overflow dentro de la tarjeta */
            scroll-snap-align: start; /* asegurar snap por tarjeta */
        }
        #recent-history-list li .order-title{ font-weight:800; color:#0b2a55; margin-bottom:6px }
        #recent-history-list li .item-row{ display:flex; gap:8px; align-items:center; font-size:13px; color: #334155 }

        /* responsive: en pantallas peque√±as hacemos la tarjeta ligeramente m√°s corta para que encaje mejor */
        @media (max-width:900px){
            #recent-history-list{ height:140px }
            #recent-history-list li{ height:124px }
            #recent-history .recent-nav button{ width:30px; height:30px }
            .floating-history{ left: calc(18px + 140px); width: 260px }
        }

        /* Responsiveness for columns and blocks */
        @media (max-width:1400px){
            .column{ min-width:120px; max-width:300px }
            .block{ height:58px }
        }
        @media (max-width:1100px){
            .column{ min-width:110px; max-width:240px }
            .block{ height:52px }
        }
        @media (max-width:700px){
            .column{ min-width:92px; max-width:160px }
            .block{ height:50px; width:90% }
        }
        /* ===== OPTIMIZACI√ìN M√ìVIL ===== */
        @media (max-width:768px){
            body {
                padding: 4px;
                gap: 8px;
                padding-bottom: 70px;
                transform: scale(1);
            }
            .container {
                gap: 8px;
                padding: 8px 4px;
                flex-wrap: wrap;
                width: 100vw;
                overflow-x: auto;
            }
            .column {
                min-width: 100px;
                max-width: 140px;
                padding: 6px 4px;
                flex-shrink: 0;
            }
            .column-header {
                font-size: 14px;
                padding: 3px 4px;
                margin-bottom: 6px;
            }
            .block {
                height: 48px;
                width: 88%;
                margin: 6px 0;
                font-size: 14px;
            }
            .block .label {
                font-size: 13px;
            }
            .main-container {
                gap: 8px;
            }
            .top-controls {
                grid-template-columns: 1fr;
                gap: 8px 12px;
                padding: 4px 0;
            }
            .top-controls button {
                height: 48px;
                font-size: 12px;
                padding: 8px 12px;
                border-radius: 8px;
            }
            .floating-actions {
                flex-direction: column;
                gap: 6px;
                left: 4px;
                top: 4px;
            }
            .manage-btn, .export-btn {
                padding: 8px 10px;
                font-size: 11px;
                height: 40px;
                border-radius: 6px;
                min-width: 70px;
            }
            .floating-history {
                margin: 8px 4px;
                width: calc(100% - 8px);
            }
            .history-card {
                padding: 8px;
                font-size: 12px;
                max-height: 180px;
            }
            .bottom-container {
                padding: 8px 4px;
                gap: 8px;
            }
        }
        @media (max-width:480px){
            body {
                padding: 2px;
                gap: 4px;
                padding-bottom: 66px;
            }
            .container {
                gap: 4px;
                padding: 4px 2px;
            }
            .column {
                min-width: 80px;
                max-width: 120px;
                padding: 4px 2px;
            }
            .column-header {
                font-size: 12px;
                padding: 2px 3px;
                margin-bottom: 4px;
            }
            .block {
                height: 44px;
                width: 85%;
                margin: 4px 0;
                font-size: 12px;
            }
            .top-controls {
                grid-template-columns: 1fr;
                gap: 6px;
                padding: 2px 0;
            }
            .top-controls button {
                height: 44px;
                font-size: 11px;
                padding: 6px 10px;
            }
            .floating-actions {
                left: 2px;
                top: 2px;
            }
            .manage-btn, .export-btn {
                padding: 6px 8px;
                font-size: 10px;
                height: 36px;
                min-width: 60px;
            }
            .col-sol-timer, .col-empty-timer {
                font-size: 10px;
                padding: 2px 4px;
            }
            .history-card {
                padding: 6px;
                font-size: 11px;
                max-height: 150px;
            }
        }
    /* panel derecho: contenedor de l√≠neas */
    .right-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: auto; /* permitir scroll interno en panel derecho */
        max-height: calc(100vh - 140px); /* dejar espacio para cabecera y controles */
    }
    .controls h3 {
        display: none;
    }
    /* Layout label + buscador en vertical */
    .controls .label-row {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
        margin-bottom: 10px;
        margin-top: 0;
    }
    .controls label {
        font-weight: bold;
        font-size: 10px;
        color: var(--glass-text);
    }
    .search-input {
        width: 100%;
        padding: 7px 9px;
        border: 1px solid rgba(0,0,0,0.08);
        border-radius: 7px;
        background: rgba(255,255,255,0.8);
        color: var(--glass-text);
        box-shadow: inset 0 4px 10px rgba(0,0,0,0.04);
        font-size: 11px;
    }
    /* buscador: atenuar elementos no coincidentes y resaltar coincidencias */
    .block.search-dim { opacity: 0.18; transform: scale(0.98); filter: grayscale(40%); }
    .block.search-match { outline: 3px solid rgba(59,130,246,0.92); box-shadow: 0 12px 32px rgba(59,130,246,0.16); transform: translateY(-4px); }
    .search-row { display:flex; gap:8px; align-items:center; }
    .search-clear { background:transparent;border:0;color:var(--muted);cursor:pointer;font-weight:700;padding:6px;border-radius:6px }
    /* historial: resaltar o atenuar entradas del historial cuando se busca */
    #recent-history-list li.history-dim { opacity: 0.28; filter: grayscale(50%); }
    #recent-history-list li.history-match { background: linear-gradient(90deg, rgba(59,130,246,0.06), rgba(59,130,246,0.02)); border-left: 4px solid rgba(59,130,246,0.9); padding-left:8px; }
    .color-boxes {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        gap: 8px;
        margin: 0;
        padding: 0;
    }
    .color-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }
    /* usar button para accesibilidad */
    .color-box {
        flex: 1;
        height: 32px;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.16s, box-shadow 0.16s, opacity 0.12s;
        background-clip: padding-box;
        padding: 0 6px;
        border: none;
        box-shadow: 0 6px 16px rgba(3,7,18,0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: white;
        font-size: 9px;
        text-align: center;
        line-height: 1.2;
        white-space: normal;
    }

    /* Botones principales (top-controls) ‚Äî m√°s altos y con acento superior */
    .top-controls .color-box{
        /* Usar anchura fluida dentro de la celda del grid y limitar por max-width */
        width: 100%;
        max-width: var(--top-btn-max-width);
        height: var(--top-btn-height);
        padding: 0 14px;
        font-size: var(--top-btn-font-size);
        letter-spacing: 0.6px;
        font-weight: 700;
        box-shadow: 0 12px 36px rgba(3,7,18,0.16);
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        justify-self: stretch; /* ocupar todo el ancho de la celda */
        align-self: center;
    }
    .top-controls .color-box::before{
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        height: 12px; /* 'grosor' visual arriba */
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.06));
        pointer-events: none;
    }
    .top-controls .color-box:active{ transform: translateY(1px) scale(0.996); }
    .color-box.blue{ box-shadow: 0 8px 30px rgba(59,130,246,0.14), 0 2px 6px rgba(0,0,0,0.25); }
    .color-box.green{ box-shadow: 0 8px 30px rgba(52,211,153,0.12), 0 2px 6px rgba(0,0,0,0.25); }
    .color-box:focus {
        outline: none;
        transform: translateY(-3px) scale(1.03);
        box-shadow: 0 14px 32px rgba(0,0,0,0.12);
    }
    .color-box:active {
        transform: translateY(0) scale(0.98);
        box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    /* drag ghost used during touch/pointer drag */
    .drag-ghost{ position:fixed; pointer-events:none; transform:translate(-50%,-50%); z-index:9999; opacity:0.95; border-radius:6px; box-shadow:0 12px 30px rgba(0,0,0,0.18); }
    /* global drag handle style (used by floating-history and top-info) */
    .drag-handle{ width:34px; height:34px; border-radius:8px; border:0; background: rgba(11,18,32,0.06); cursor:grab; display:inline-flex; align-items:center; justify-content:center; font-weight:800; color: var(--glass-text); touch-action:none; }
    .drag-handle:active{ cursor:grabbing }
    /* visual highlight for drop target */
    .btn-drop-target{ box-shadow: 0 0 0 6px rgba(59,130,246,0.12) !important; transform: translateY(-2px) scale(1.02) !important; }
    /* barcode modal */
    .barcode-modal{ position: fixed; left:50%; top:50%; transform:translate(-50%,-50%); background: #fff; border-radius:10px; box-shadow:0 20px 40px rgba(2,6,23,0.18); padding:14px; z-index:13000; width:360px; max-width:92vw; display:none; }
    .barcode-modal.open{ display:block; }
    .barcode-modal h3{ margin:0 0 8px 0; font-size:16px }
    .barcode-modal .scan-list{ max-height:220px; overflow:auto; margin:8px 0; padding:6px; border-radius:6px; background: #f8fafc; }
    .barcode-modal .scan-item{ padding:6px 8px; border-bottom:1px solid rgba(0,0,0,0.04); font-weight:600 }
    .barcode-modal .modal-actions{ display:flex; gap:8px; margin-top:8px }
    .color-box:hover {
        transform: translateY(-6px) scale(1.04);
        filter: saturate(1.08);
    }
    /* ajustar etiqueta debajo del bot√≥n para mantenerse legible */
    .color-label {
        font-size: 9px;
        text-align: center;
        color: var(--glass-text);
        font-weight: 600;
        line-height: 1.1;
        max-width: 100%;
    }
    .color-label {
        font-size: 12px;
        text-align: center;
        max-width: 110px;
        color: var(--glass-text);
        font-weight: 500;
    }
    .blue { background-color: #3498db; }
    .green { background-color: #2ecc71; }
    .orange { background-color: #f97316; }
    .status {
        min-height: 16px;
        color: var(--glass-text);
        font-size: 12px;
        margin-top: 10px;
        text-align: center;
    }
    /* resaltar columna seleccionada sin cambiar layout */
    .column.selected {
        box-shadow: 0 20px 50px rgba(59,130,246,0.14), 0 6px 18px rgba(0,0,0,0.1);
        transform: translateY(-8px);
    }
    /* alerta llamativa para l√≠neas vac√≠as */
    .alert {
        width: calc(100% - 80px);
        max-width: 1100px;
        background: linear-gradient(90deg,#e74c3c,#ec7063);
        color: #fff;
        padding: 12px 16px;
        border-radius: 6px;
        box-shadow: 0 6px 18px rgba(231,76,60,0.22);
        font-weight: 700;
        text-align: center;
        margin-bottom: 8px;
        animation: pulse 1.6s ease-in-out infinite;
        position: relative;
        z-index: 9999; /* ensure it's above other elements */
        transition: opacity 220ms ease, transform 260ms ease;
    }
    .alert.hidden { display: none !important; opacity:0 }
    @keyframes pulse {
        0% { transform: translateY(0); box-shadow: 0 6px 18px rgba(0,0,0,0.18); }
        50% { transform: translateY(-4px); box-shadow: 0 10px 24px rgba(0,0,0,0.26); }
        100% { transform: translateY(0); box-shadow: 0 6px 18px rgba(0,0,0,0.18); }
    }
    /* marcar visualmente columnas sin parciales */
    .column.empty {
        border: 3px solid rgba(231,76,60,0.95);
        outline: none;
        box-shadow: 0 14px 34px rgba(231,76,60,0.20), 0 0 0 6px rgba(231,76,60,0.06) inset;
        transform: translateY(-2px);
        transition: box-shadow 260ms ease, transform 260ms ease, border-color 260ms ease;
        position: relative;
    }
    @keyframes pulse-empty {
        0% { box-shadow: 0 10px 26px rgba(231,76,60,0.16), 0 0 0 0 rgba(231,76,60,0); transform: translateY(0); }
        50% { box-shadow: 0 18px 42px rgba(231,76,60,0.28), 0 0 16px rgba(231,76,60,0.08); transform: translateY(-4px); }
        100% { box-shadow: 0 10px 26px rgba(231,76,60,0.16), 0 0 0 0 rgba(231,76,60,0); transform: translateY(0); }
    }
    .column.empty.animate {
        animation: pulse-empty 1.6s ease-in-out infinite;
    }
    /* visual de l√≠nea inactiva */
    .column.inactive {
        opacity: 0.44;
        filter: grayscale(70%);
        transform: none !important;
    }
    .inactive-badge{
        position:absolute;
        top:-16px;
        right:8px;
        color:#fff;
        padding:4px 8px;
        border-radius:8px;
        font-size:11px;
        background: rgba(125,31,31,0.92);
        box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    }
    /* toggle switch para activar/desactivar l√≠nea */
    .toggle-switch{
        position: absolute; top: -14px; left: 8px;
        width: 36px; height: 18px;
        background: #e5e7eb; border: none; border-radius: 9px;
        cursor: pointer; transition: all 220ms ease;
        display: flex; align-items: center; padding: 0 2px;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    .toggle-switch.active{ background: #10b981; }
    .toggle-switch::after{
        content: '';
        width: 14px;
        height: 14px;
        background: white;
        border-radius: 50%;
        transition: transform 220ms ease;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    /* move the knob to the right based on the smaller width (36 - 14 - padding*2 = 20) */
    .toggle-switch.active::after{ transform: translateX(20px); }
    .toggle-switch:hover{ transform: scale(1.05); }
    /* t√≠tulo con efecto glassmorphism */
    .title {
        font-size: 26px;
        font-weight: 700;
        letter-spacing: -0.5px;
        color: var(--glass-text);
        text-align: center;
        background: linear-gradient(135deg, rgba(255,255,255,0.75), rgba(255,255,255,0.55));
        backdrop-filter: blur(12px) saturate(150%);
        padding: 12px 28px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.6);
        box-shadow: 0 8px 32px rgba(0,0,0,0.06), inset 0 1px 1px rgba(255,255,255,0.9);
        max-width: 520px;
        margin-top: -10px;
        margin-bottom: 8px;
        background-clip: text;
    }
    .manage-btn{
        margin-top:12px;
        display:inline-block;
        width:100%;
        padding:10px 12px;
        border-radius:10px;
        background: linear-gradient(90deg,var(--accent2), #60a5fa);
        color:white;
        border:none;
        cursor:pointer;
        font-weight:700;
        box-shadow: 0 10px 26px rgba(59,130,246,0.12);
    }
    .manage-btn:active{ transform: translateY(1px) }
    /* panel de reporte de l√≠neas vac√≠as (lista roja) */
    .empty-report{
        width: 280px;
        background: linear-gradient(180deg,#ff1f1f,#e73b3b);
        color: #fff;
        padding: 18px 16px;
        border-radius: 10px;
        box-shadow: 0 14px 36px rgba(231,76,60,0.18);
        font-weight:700;
        text-align: left;
        margin-bottom: 6px;
        display: none;
    }
    .empty-report.show{ display: block; }
    .empty-report h3{ margin:0 0 8px 0; font-size:18px; text-align:center }
    .empty-report ul{ margin:10px 0 0 12px; padding:0; list-style:none }
    .empty-report li{ margin:6px 0; font-weight:700; font-size:15px }
    .empty-report .note{ font-weight:600; font-size:12px; opacity:0.95; margin-top:8px }
    /* panel de gesti√≥n embebido (slide-over) */
    .manage-panel{
        position: fixed; right: 0; top: 0; bottom: 0; width: 420px; max-width: 92vw;
        background: #ffffff; box-shadow: -18px 0 40px rgba(2,6,23,0.12); transform: translateX(110%);
        transition: transform 280ms cubic-bezier(.2,.9,.25,1); z-index:12000; padding:18px; overflow:auto;
    }
    .manage-panel.open{ transform: translateX(0); }
    /* make sure controls-area stacks on small screens */
    @media (max-width:900px){
        .controls-area{ flex-direction: column; align-items: stretch }
        .empty-report{ width: 100%; }
        .controls{ width: 100% }
    }
    /* top-right info: current date/time and durations of empty lines */
    .top-info{
        position: static; margin-top:12px; z-index: 2;
        background: rgba(255,255,255,0.95); color:#0f172a; padding:10px 12px; border-radius:10px;
        box-shadow: 0 8px 18px rgba(2,6,23,0.06); font-size:13px; text-align:left;
        width:100%; max-width:100%; box-sizing: border-box; border:1px solid rgba(0,0,0,0.04);
        /* prevent the internal content from forcing the card wider than its parent */
        overflow: hidden;
    }
    .top-info .now{ font-weight:700; font-size:14px }
    .top-info .durations{ margin-top:8px; text-align:left; }
    .top-info .durations ul{ margin:0; padding:6px 8px; list-style:none; max-height:220px; overflow:auto }
    .top-info .durations li{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding:4px 2px; margin:6px 0; box-sizing:border-box; }
    .top-info .durations li span.name{ display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:#6b7280; font-weight:600; font-size:13px; }
    .top-info .durations li span.time{ flex-shrink:0; color:#6b7280; font-weight:700; font-size:13px; margin-left:6px; }
    .top-info .durations li.current span.name{ color:#b91c1c; font-weight:800; }
    .top-info .durations li.current span.time{ color:#b91c1c; }
    .top-info .durations li.stopped span.name{ color:#6b7280; font-weight:700; }
    .top-info .durations li.stopped span.time{ color:#6b7280; opacity:0.92; font-weight:700; }

    /* versiones compactas del top-info cuando se inserta dentro del panel flotante */
    .floating-history .floating-top-info{
        background: rgba(255,255,255,0.96);
        padding:8px 10px;
        border-radius:10px;
        box-shadow: 0 8px 18px rgba(2,6,23,0.04);
        border:1px solid rgba(0,0,0,0.04);
        width:100%;
        box-sizing:border-box;
    }

    /* Top-info compact dentro de la fila superior de controles */
    /* mover la info compacta a un lugar fijo en la esquina superior derecha
       para que NO cambie la ubicaci√≥n original de los botones */
    .top-controls .top-info-compact{
        display: none !important;
    }
    .top-controls .top-info-compact .now{ font-weight:700; font-size:13px; margin-bottom:4px }
    .top-controls .top-info-compact .durations{ display:flex; gap:8px; align-items:center; justify-content:space-between }
    .top-controls .top-info-compact .durations ul{ margin:0; padding:0; list-style:none; display:flex; gap:8px; align-items:center; }
    .top-controls .top-info-compact .durations li{ font-weight:700; color:#b91c1c; font-size:13px }
    .floating-history .floating-top-info .now{ font-size:13px; font-weight:700 }
    .floating-history .floating-top-info .durations ul{ max-height:76px; overflow:auto; padding:0; margin:6px 0 0 0 }
    .manage-panel h2{ margin-top:0 }
    .manage-row{ display:flex; gap:8px; margin-bottom:10px }
    .manage-row input[type=text]{ flex:1; padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.08) }
    .manage-row input[type=number]{ width:92px; padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.08) }
    .manage-list{ display:flex; flex-direction:column; gap:8px; margin-top:8px }
    .manage-item{ display:flex; gap:8px; align-items:center }
    .manage-item input{ padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.08) }
    .manage-actions{ display:flex; gap:8px; margin-top:12px }
    
    /* ===== BARRA DE NAVEGACI√ìN M√ìVIL ===== */
    @media (max-width:768px){
        #mobile-bottom-nav {
            display: flex;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, #ffffff, #fbfdff);
            border-top: 1px solid rgba(0,0,0,0.1);
            gap: 0;
            z-index: 110;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.08);
        }
        
        #mobile-bottom-nav button {
            flex: 1;
            background: transparent;
            border: none;
            border-top: 3px solid transparent;
            color: #666;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            transition: all 120ms ease;
            padding: 4px 0;
        }
        
        #mobile-bottom-nav button:active,
        #mobile-bottom-nav button.active {
            border-top-color: #3b82f6;
            color: #3b82f6;
            background: rgba(59,130,246,0.05);
        }
        
        #mobile-bottom-nav .icon {
            font-size: 18px;
        }
        
        /* Agregar padding inferior al body para que no se oculte contenido */
        body {
            padding-bottom: 70px;
        }
        
        @media (max-width:480px){
            #mobile-bottom-nav {
                height: 56px;
            }
            #mobile-bottom-nav button {
                font-size: 10px;
            }
            body {
                padding-bottom: 66px;
            }
        }
    }
    
    @media (min-width:769px){
        #mobile-bottom-nav {
            display: none !important;
        }
    }
</style>
<!-- Firebase SDK (compat - works without modules) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<!-- Firebase Sync Module -->
<script src="firebase-sync.js"></script>
</head>
<body>
    <!-- Barra de navegaci√≥n inferior (solo en m√≥vil) -->
    <div id="mobile-bottom-nav">
        <button id="nav-kanban" class="active" data-tab="kanban">
            <span class="icon">üìä</span>
            <span>Kanban</span>
        </button>
        <button id="nav-panel" data-tab="panel">
            <span class="icon">‚öôÔ∏è</span>
            <span>Panel</span>
        </button>
        <button id="nav-export" data-tab="export">
            <span class="icon">üì•</span>
            <span>Exportar</span>
        </button>
        <button id="nav-sync" data-tab="sync">
            <span class="icon">üîÑ</span>
            <span>Sincronizar</span>
        </button>
    </div>
    
    <!-- floating action buttons in top-left (visual placement only) -->
    <div id="floating-actions" class="floating-actions" aria-hidden="false">
        <button id="manage-lines-btn" class="manage-btn" type="button">Gestionar l√≠neas</button>
        <!-- Export moved to internal control panel -->
        <!-- <button id="export-history-csv" class="export-btn" type="button">Exportar Excel</button> -->
    </div>
    <!-- floating history card to the right of actions (keeps same IDs so JS still works) -->
    <div id="floating-history" class="floating-history" aria-live="polite">
        <div id="recent-history" class="history-card small-box" aria-live="polite">
            <div style="font-weight:700;margin-bottom:6px">√öltimos 5 parciales abastecidos</div>
            <!-- top-info previously here ‚Äî moved to top-controls as compact version -->
            <div class="recent-list-wrap" style="position:relative">
                <ul id="recent-history-list"></ul>
                <div class="recent-nav" aria-hidden="true" style="display:none;">
                    <button id="recent-prev" aria-label="Ver anterior">‚ñ≤</button>
                    <button id="recent-next" aria-label="Ver siguiente">‚ñº</button>
                </div>
            </div>
        </div>
    </div>
    <!-- (alert banner removed ‚Äî using red report panel below) -->
    <!-- panel de reporte de l√≠neas vac√≠as (se ubicar√° junto al panel de controles) -->
    <!-- el elemento se inserta junto a .controls m√°s abajo -->

    <!-- panel embebido de gesti√≥n de l√≠neas -->
    <aside id="manage-panel" class="manage-panel" aria-hidden="true">
        <h2>Gestionar l√≠neas</h2>
        <p class="small">A√±ade, edita o quita l√≠neas. Los cambios se guardan en tu navegador y la vista principal se actualizar√° autom√°ticamente.</p>
        <div class="manage-row">
            <input id="m-new-name" type="text" placeholder="Nombre nueva l√≠nea (ej. PK11)" />
            <button id="m-btn-add" class="btn btn-add">A√±adir</button>
        </div>
        <div id="m-lines-list" class="manage-list"></div>
        <div class="manage-actions">
            <button id="m-btn-save" class="btn btn-save">Guardar</button>
            <button id="m-btn-close" class="btn" style="margin-left:auto">Cerrar</button>
        </div>
    </aside>
    <h1 class="title" style="font-size:32px; font-weight:800; margin-top:18px; margin-bottom:18px; text-align:center; letter-spacing:1px; background: linear-gradient(135deg, rgba(255,255,255,0.85), rgba(255,255,255,0.65)); color:#0f172a;">ESTATUS FLUJO PACIALES DE VIDRIO</h1>
    <!-- (removed stray closing tag that broke DOM structure) -->
    <script>
    // wire the visible "Probar historial" button (creates a test entry and updates the UI)
    (function(){
        function showStatus(msg, timeout=3000){
            try{
                // Useful diagnostic: dynamic imports will fail if the page is opened via file://
                if(location.protocol === 'file:'){
                    const msg = 'No se puede importar m√≥dulos din√°micos cuando el archivo est√° abierto con file://. Usa un servidor local (python -m http.server o npx http-server) y abre http://localhost:PORT.';
                    console.error(msg);
                    showStatus(msg);
                    throw new Error(msg);
                }
                let el = document.getElementById('hist-test-status');
                if(!el){
                    // find the correct container: the element with id recent-history
                    const wrap = document.querySelector('#recent-history');
                    if(!wrap) {
                        console.warn('showStatus: recent-history container not found');
                    } else {
                        el = document.createElement('div');
                        el.id = 'hist-test-status';
                        el.style.fontSize = '12px';
                        el.style.color = '#0b1220';
                        el.style.opacity = 0.85;
                        el.style.marginTop = '6px';
                        wrap.appendChild(el);
                    }
                }
                el.textContent = msg;
                if(timeout>0) setTimeout(()=>{ try{ el.textContent = ''; }catch(e){} }, timeout);
            }catch(e){ console.warn('showStatus failed', e); }
        }

        const btn = document.getElementById('btn-test-history');
        if(btn){
            btn.addEventListener('click', async ()=>{
                try{
                    if(!window.testAddHistory) { showStatus('Helper no disponible (usa consola)'); return; }
                    showStatus('Creando entrada de prueba...', 60000);
                    await window.testAddHistory();
                    showStatus('Entrada de prueba solicitada. Revisa el historial (o consola).', 4000);
                }catch(e){ console.error('test history failed', e); showStatus('Error creando entrada, revisa la consola'); }
            });
        }
    })();
    // ==========================================
    // CARGAR DATOS DESDE FIREBASE AL INICIAR
    // ==========================================
    // CARGAR DATOS Y LISTENERS AL INICIAR (Se ejecutar√° cuando Firebase est√© listo)
    // ==========================================
    // Nota: Estos se llaman en DOMContentLoaded + initFirebaseSync m√°s adelante
    // (async function(){
    //     try{
    //         if(window.firebaseInitPromise){
    //             await window.firebaseInitPromise;
    //         }
    //         console.log('üöÄ Cargando datos desde Firebase al iniciar...');
    //         await loadAllDataFromFirebase();
    //         // Iniciar listeners en tiempo real despu√©s de la carga inicial
    //         await initFirebaseSync();
    //     }catch(e){
    //         console.warn('‚ö† Error en carga inicial de Firebase:', e);
    //     }
    // })();

    document.addEventListener('DOMContentLoaded', function(){
        const input = document.getElementById('line-name');
        const btnAdd = document.getElementById('btn-entrada');
        const btnRemove = document.getElementById('btn-salida');
        const status = document.getElementById('control-status');

        // Inicializar l√≠neas por defecto si no existen en localStorage
        try{
            const storedLines = localStorage.getItem('pk_lines');
            if(!storedLines || JSON.parse(storedLines).length === 0){
                const defaultLines = [
                    { name: 'PKB1', count: 0, active: true },
                    { name: 'PKB2', count: 0, active: true },
                    { name: 'PKB3', count: 0, active: true },
                    { name: 'PKB4', count: 0, active: true },
                    { name: 'PKB5', count: 0, active: true },
                    { name: 'PKB6', count: 0, active: true },
                    { name: 'JVH2', count: 0, active: true },
                    { name: 'EYS', count: 0, active: true },
                    { name: 'MAQ', count: 0, active: true }
                ];
                localStorage.setItem('pk_lines', JSON.stringify(defaultLines));
                if(window.applyLinesToDOM){
                    window.applyLinesToDOM(defaultLines);
                    console.log('üé® L√≠neas por defecto aplicadas');
                }
            }
        }catch(e){
            console.warn('Error inicializando l√≠neas por defecto:', e);
        }

        // Do NOT reset persisted timers on load. Preserve `pk_solicitud_salida` and `pk_empty_since` so
        // durations survive page reloads. Run a small deferred refresh of timer UI to pick up stored values.
        try{ setTimeout(()=>{ try{ ensureTimerElements(); updateColumnTimers(); window.updateSolicitudDurationsDisplay && window.updateSolicitudDurationsDisplay(); window.updateEmptyDurationsDisplay && window.updateEmptyDurationsDisplay(); }catch(e){} }, 50); }catch(e){}

        

        // poblar datalist con las l√≠neas existentes
        function populateDatalist(){
            const dl = document.getElementById('line-list');
            if(!dl) return;
            dl.innerHTML = '';
            const headers = document.querySelectorAll('.container .column .column-header');
            headers.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h.textContent.trim();
                dl.appendChild(opt);
            });
        }
        // helper global: append history entries and refresh the recent-history UI
        function addHistoryEntries(entries){
            try{
                if(!Array.isArray(entries) || entries.length === 0) return;
                let hist = [];
                try{ hist = JSON.parse(localStorage.getItem('pk_history')||'[]'); }catch(e){ hist = []; }
                hist = hist.concat(entries || []);
                hist = hist.slice(-200);
                localStorage.setItem('pk_history', JSON.stringify(hist));
                try{ window.historialModule && window.historialModule.renderizar(); }catch(e){}
                // Also persist to Firestore if available
                try{
                    // Local storage only
                }catch(e){ console.warn('addHistoryEntries -> firestore save failed', e); }
            }catch(err){ console.error('addHistoryEntries failed', err); }
        }
        // llenar la lista desplegable con las l√≠neas actuales
        populateDatalist();

        // funci√≥n que detecta l√≠neas sin parciales y muestra alerta
        function checkEmptyLines(){
            // only direct children columns to avoid accidental matches
            const cols = Array.from(document.querySelectorAll('.container > .column'));
            const emptyNames = [];
            // load existing empty timestamps mapping
            let emptySince = {};
            try{ emptySince = JSON.parse(localStorage.getItem('pk_empty_since')||'{}'); }catch(e){ emptySince = {}; }
            let changed = false;
            cols.forEach(c => {
                // skip inactive lines from empty checks
                if(c.classList.contains('inactive')) {
                    const header = (c.querySelector('.column-header')||{textContent:''}).textContent.trim();
                    try{
                        const mapRaw = localStorage.getItem('pk_empty_since');
                        const map = mapRaw ? JSON.parse(mapRaw) : {};
                        if(map[header]){ delete map[header]; localStorage.setItem('pk_empty_since', JSON.stringify(map)); changed = true; }
                    }catch(e){}
                    c.classList.remove('empty');
                    return;
                }
                const blocks = c.querySelectorAll('.block').length;
                const header = (c.querySelector('.column-header')||{textContent:'?'}).textContent.trim();
                if(blocks === 0){
                    c.classList.add('empty');
                    if(header) {
                        emptyNames.push(header);
                        if(!emptySince[header]){ emptySince[header] = Date.now(); changed = true; }
                    }
                } else {
                    c.classList.remove('empty');
                    if(header && emptySince[header]){ delete emptySince[header]; changed = true; }
                }
            });
            // deduplicate and clean names
            const names = Array.from(new Set(emptyNames.map(n=>n.trim()).filter(Boolean)));
            
            // Alert if new lines became empty
            if(names.length > 0){
                const newEmpty = names.filter(n => !emptySince[n] || (emptySince[n] && Date.now() - emptySince[n] < 2000));
                if(newEmpty.length > 0){
                    console.warn('‚ö†Ô∏è L√≠neas sin parciales detectadas:', newEmpty);
                    // Only alert once per session per line to avoid spam
                    newEmpty.forEach(lineName => {
                        if(!window._emptyLineAlerted) window._emptyLineAlerted = {};
                        if(!window._emptyLineAlerted[lineName]){
                            // Alert user about empty line
                            // (commented out to avoid too many alerts, but logged to console)
                            window._emptyLineAlerted[lineName] = true;
                        }
                    });
                }
            }
            
            // render the red report panel
            const report = document.getElementById('empty-report');
            const list = document.getElementById('empty-report-list');
            if(report && list){
                list.innerHTML = '';
                if(names.length > 0){
                    names.forEach(n=>{
                        const li = document.createElement('li'); li.textContent = n; list.appendChild(li);
                    });
                    report.classList.add('show');
                    report.setAttribute('aria-hidden','false');
                } else {
                    report.classList.remove('show');
                    report.setAttribute('aria-hidden','true');
                    list.innerHTML = '';
                }
            }
            // persist empty timestamps if changed
            try{ if(changed) localStorage.setItem('pk_empty_since', JSON.stringify(emptySince)); }catch(e){}
            // update durations display
            try{ updateEmptyDurationsDisplay(); }catch(e){}
        }
        // ejecutar la comprobaci√≥n inicial
        checkEmptyLines();

        // desactivar selecci√≥n por click sobre la cabecera: la √∫nica forma de abastecer Kamban
        // ser√° mediante el bot√≥n "ABASTECER KAMBAN" (btn-entrada) que abre la ventana/modal.
        function setupHeaderClicks(){
            const headers = document.querySelectorAll('.container .column .column-header');
            headers.forEach(h => {
                // ensure header does not indicate clickability
                h.style.cursor = 'default';
                // remove any inline onclick handlers if present
                try{ h.onclick = null; }catch(e){}
            });
            // add a single capture-phase guard to prevent header clicks from triggering other handlers
            try{
                if(!window._headerClickGuardAdded){
                    document.addEventListener('click', function(e){
                        const hh = e.target && e.target.closest && e.target.closest('.column-header');
                        if(hh){
                            e.stopPropagation();
                            e.preventDefault();
                            // no-op: prevent using header to select or open modals
                        }
                    }, true);
                    window._headerClickGuardAdded = true;
                }
            }catch(e){ console.warn('failed to add header click guard', e); }
        }
        setupHeaderClicks();
        // setup selection of parciales (blocks)
        function setupBlockSelection(){
            const blocks = document.querySelectorAll('.container .column .block');
            blocks.forEach(b => {
                b.style.cursor = 'pointer';
                // remove any existing handler we may have attached earlier
                if(b._selectHandler) b.removeEventListener('click', b._selectHandler);
                b._selectHandler = function(e){
                    // only allow selecting visible, non-inactive columns
                    const col = b.closest('.column');
                    if(col && col.classList.contains('inactive')) return;
                    // ensure this block has correct data attributes before toggling
                    try{
                        const lineName = (col && col.querySelector('.column-header')||{textContent:''}).textContent.trim();
                        if(!b.hasAttribute('data-line')) b.setAttribute('data-line', lineName);
                        // compute index if missing or inconsistent
                        if(!b.hasAttribute('data-index')){
                            const siblings = Array.from(col.querySelectorAll('.block'));
                            const idx = siblings.indexOf(b);
                            b.setAttribute('data-index', String(idx));
                        }
                    }catch(err){ console.warn('ensure data attrs failed', err); }
                    // enforce single selection: deselect others, then toggle this one
                    try{ document.querySelectorAll('.block.selected-parcial').forEach(x=>{ if(x!==b) x.classList.remove('selected-parcial'); }); }catch(e){}
                    if(b.classList.contains('selected-parcial')){
                        // if already selected, unselect it (no selection)
                        b.classList.remove('selected-parcial');
                    } else {
                        // select this block only
                        b.classList.add('selected-parcial');
                    }
                    // update status: show how many selected
                    try{
                        const count = document.querySelectorAll('.block.selected-parcial').length;
                        if(count === 0) status.textContent = '';
                        else status.textContent = `${count} parcial(es) seleccionado(s).`;
                    }catch(e){}
                };
                b.addEventListener('click', b._selectHandler);
                // pointer/touch drag support: start drag on pointerdown
                if(b._pointerDownHandler) b.removeEventListener('pointerdown', b._pointerDownHandler);
                b._pointerDownHandler = function(ev){
                    try{ startDrag(b, ev); }catch(err){ console.warn('drag start failed', err); }
                };
                b.addEventListener('pointerdown', b._pointerDownHandler);
                // touch fallback for devices that don't support Pointer Events
                if(b._touchStartHandler) b.removeEventListener('touchstart', b._touchStartHandler);
                b._touchStartHandler = function(ev){
                    try{
                        // prevent default to avoid page scroll while dragging
                        if(ev.cancelable) ev.preventDefault();
                        // pass the touch event to the same startDrag function
                        startDrag(b, ev);
                    }catch(err){ console.warn('touch drag start failed', err); }
                };
                b.addEventListener('touchstart', b._touchStartHandler, { passive: false });
            });
        }
        setupBlockSelection();

        function findColumn(name){
            if(!name) return null;
            const cols = document.querySelectorAll('.container .column');
            const target = Array.from(cols).find(col => {
                const h = col.querySelector('.column-header');
                return h && h.textContent.trim().toLowerCase() === name.trim().toLowerCase();
            });
            return target || null;
        }

        // Drag and drop (pointer/touch) for blocks - drop on ABASTECER AB (btn-salida)
        let _dragState = null;
        const btnSalida = document.getElementById('btn-salida');

        function startDrag(block, ev){
            if(_dragState) return; // prevent nested drags
            // only start if primary button / primary pointer
            if(ev && ev.button && ev.button !== 0) return;
            ev.preventDefault && ev.preventDefault();
            // compute which blocks will be dragged: selected group or the single block
            // only allow one selected block: if exists use it, otherwise use the clicked block
            const selected = document.querySelector('.block.selected-parcial');
            const dragged = selected ? [selected] : [block];

            // create ghost element
            const ghost = block.cloneNode(true);
            ghost.classList.add('drag-ghost');
            ghost.style.width = Math.max(52, block.offsetWidth) + 'px';
            ghost.style.height = Math.max(32, block.offsetHeight) + 'px';
            document.body.appendChild(ghost);

            _dragState = { dragged, ghost, pointerId: ev.pointerId || null };

            // capture pointer for the initiating block if possible
            try{ if(ev.target && ev.pointerId) ev.target.setPointerCapture && ev.target.setPointerCapture(ev.pointerId); }catch(e){}

            // initial position
            const x = ev.clientX || (ev.touches && ev.touches[0] && ev.touches[0].clientX) || 0;
            const y = ev.clientY || (ev.touches && ev.touches[0] && ev.touches[0].clientY) || 0;
            _dragState.ghost.style.left = x + 'px'; _dragState.ghost.style.top = y + 'px';

            // attach move/up listeners on document
            document.addEventListener('pointermove', onPointerMove);
            document.addEventListener('pointerup', onPointerUp);
            document.addEventListener('pointercancel', onPointerUp);
            // touch fallbacks
            document.addEventListener('touchmove', onTouchMove, { passive: false });
            document.addEventListener('touchend', onTouchEnd);
            document.addEventListener('touchcancel', onTouchEnd);
            // small visual cue on target
            if(btnSalida) btnSalida.classList.add('drop-ready');
        }

        function onTouchMove(ev){
            if(!ev || !ev.touches || ev.touches.length === 0) return;
            // prevent native scrolling while dragging
            if(ev.cancelable) ev.preventDefault();
            const t = ev.touches[0];
            onPointerMove({ clientX: t.clientX, clientY: t.clientY });
        }

        function onTouchEnd(ev){
            // use changedTouches for end coordinate if available
            const t = (ev && ev.changedTouches && ev.changedTouches[0]) || (ev && ev.touches && ev.touches[0]) || null;
            const fake = t ? { clientX: t.clientX, clientY: t.clientY } : (ev || {});
            onPointerUp(fake);
        }

        function onPointerMove(ev){
            if(!_dragState) return;
            const x = ev.clientX; const y = ev.clientY;
            if(_dragState.ghost){ _dragState.ghost.style.left = x + 'px'; _dragState.ghost.style.top = y + 'px'; }
            // highlight drop target if hovering
            if(btnSalida){
                const el = document.elementFromPoint(x, y);
                if(el && (el === btnSalida || btnSalida.contains(el))){ btnSalida.classList.add('btn-drop-target'); }
                else btnSalida.classList.remove('btn-drop-target');
            }
        }

        function onPointerUp(ev){
            if(!_dragState) return;
            const x = ev.clientX; const y = ev.clientY;
            // determine drop target
            let dropEl = document.elementFromPoint(x,y);
            const isOnBtn = dropEl && (dropEl === btnSalida || (btnSalida && btnSalida.contains(dropEl)));
                if(isOnBtn){
                    // perform abastecer-ab for all dragged blocks: collect info, save history, remove nodes,
                    // set solicitud+salida for their lines (now) and rebuild requested map from DOM.
                    const now = Date.now();
                    // collect unique dragged elements
                    const uniq = Array.from(new Set(_dragState.dragged || []));
                    // collect metadata for each dragged block BEFORE removing it
                    const removedBlocks = uniq.map(b => {
                        try{
                            const col = b.closest('.column');
                            const line = (col && col.querySelector('.column-header')||{textContent:''}).textContent.trim();
                            const idx = parseInt(b.getAttribute('data-index')||'-1',10);
                            const name = b.getAttribute('data-name') || ((b.querySelector('.label')||{}).textContent||'').trim();
                            return { el: b, line, index: idx, name };
                        }catch(e){ return null; }
                    }).filter(Boolean);
                    const lines = Array.from(new Set(removedBlocks.map(r=>r.line))).filter(Boolean);

                    // load solicitud map BEFORE overwriting so we can compute durations
                    let solicitudMap = {};
                    try{ solicitudMap = JSON.parse(localStorage.getItem('pk_solicitud_salida')||'{}'); }catch(e){ solicitudMap = {}; }

                    // load existing history, append new entries for each removed block
                    let newEntries = [];
                    removedBlocks.forEach(async rb => {
                        try{
                            const prevSolic = solicitudMap[rb.line] && solicitudMap[rb.line].solicitud ? parseInt(solicitudMap[rb.line].solicitud,10) : null;
                            const duration = prevSolic ? Math.max(0, now - prevSolic) : 0;
                            newEntries.push({ name: rb.name || (`${rb.line}#${rb.index}`), line: rb.line, index: rb.index, requestedAt: prevSolic || now, suppliedAt: now, duration });
                            // NUEVO: Registrar abastecimiento en Firebase
                            if(window.FirebaseSync){
                                await window.FirebaseSync.addAbastecimiento(rb.line, rb.name || (`${rb.line}#${rb.index}`));
                            }
                        }catch(e){ console.error('Error registrando abastecimiento en Firebase:', e); }
                    });
                    // persist via helper so view is refreshed
                    try{ addHistoryEntries(newEntries); }catch(e){}

                    // remove dragged blocks from DOM
                    try{ uniq.forEach(b => { try{ if(b && b.parentNode) b.parentNode.removeChild(b); }catch(e){} }); }catch(e){}

                    // after removals, ensure attributes are consistent and rebuild names mapping
                    try{ ensureBlockDataAttributes(); rebuildBlockNamesFromDOM(); }catch(e){}

                    // update solicitud map for affected lines: set solicitud+salida = now
                    lines.forEach(lineName => {
                        if(!lineName) return;
                        solicitudMap[lineName] = solicitudMap[lineName] || {};
                        solicitudMap[lineName].solicitud = now;
                        solicitudMap[lineName].salida = now;
                    });
                    try{ localStorage.setItem('pk_solicitud_salida', JSON.stringify(solicitudMap)); }catch(e){}

                    // rebuild requested map based on remaining DOM (removes requested indices that no longer exist)
                    try{ rebuildRequestedFromDOM(); }catch(e){}
                    // persist current lines state (counts, active)
                    try{ saveState(); }catch(e){}
                    // apply UI updates
                    try{ applyRequestedToDOM(); ensureTimerElements(); updateColumnTimers(); window.updateSolicitudDurationsDisplay && window.updateSolicitudDurationsDisplay(); window.historialModule && window.historialModule.renderizar(); }catch(e){}
                    
                    // Mostrar notificaci√≥n de √©xito despu√©s de drag-drop
                    setTimeout(()=>{
                        try{ 
                            const status = document.getElementById('control-status');
                            if(status){
                                status.style.display = 'block';
                                status.textContent = '‚úÖ Parcial abastecido correctamente'; 
                                alert('‚úÖ Parcial abastecido correctamente');
                                setTimeout(()=>{ 
                                    status.textContent = ''; 
                                    status.style.display = 'none';
                                }, 3000); 
                            }
                        }catch(e){}
                    }, 300);
                }

            // cleanup
            try{ if(_dragState.ghost) _dragState.ghost.remove(); }catch(e){}
            if(btnSalida) btnSalida.classList.remove('btn-drop-target','drop-ready');
            document.removeEventListener('pointermove', onPointerMove);
            document.removeEventListener('pointerup', onPointerUp);
            document.removeEventListener('pointercancel', onPointerUp);
            document.removeEventListener('touchmove', onTouchMove);
            document.removeEventListener('touchend', onTouchEnd);
            document.removeEventListener('touchcancel', onTouchEnd);
            _dragState = null;
        }

        async function addPartial(name){
            // backward-compatible signature: addPartial(lineName, blockLabel)
            const lineName = name;
            const blockLabel = arguments.length > 1 ? arguments[1] : undefined;
            const col = findColumn(lineName);
            if(!col){
                status.textContent = `L√≠nea "${lineName}" no encontrada.`;
                return;
            }
            if(col.classList.contains('inactive')){
                status.textContent = `L√≠nea "${name}" est√° inactiva. No se pueden a√±adir parciales.`;
                return;
            }
            // Local storage only - Firebase removed

            const block = document.createElement('div');
            block.className = 'block appear';
            // set data attributes so persistence works
                // cleanup requested map: remove any requested indices >= new count
                try{
                    const lineName = name;
                    const map = getRequestedMap();
                    const arr = Array.isArray(map[lineName]) ? map[lineName] : [];
                    const newCount = col.querySelectorAll('.block').length;
                    const cleaned = arr.filter(i => i < newCount);
                    if(cleaned.length > 0) map[lineName] = cleaned; else delete map[lineName];
                    saveRequestedMap(map);
                }catch(e){}
            const idx = col.querySelectorAll('.block').length; // next index
                try{ saveState(); }catch(e){ /* ignore */ }
            block.setAttribute('data-index', String(idx));
            if(blockLabel){
                block.setAttribute('data-name', blockLabel);
                const span = document.createElement('span'); span.className = 'label'; span.textContent = blockLabel; block.appendChild(span);
                // persist name in pk_block_names
                try{
                    const names = JSON.parse(localStorage.getItem('pk_block_names')||'{}');
                    names[lineName] = names[lineName] || {};
                    names[lineName][String(idx)] = blockLabel;
                    localStorage.setItem('pk_block_names', JSON.stringify(names));
                }catch(e){}
            }
            // if this index is in requested map, mark requested
            try{
                const map = getRequestedMap();
                const arr = Array.isArray(map[lineName]) ? map[lineName] : [];
                if(arr.indexOf(idx) !== -1) block.classList.add('requested');
            }catch(e){}
            col.appendChild(block);
            // ensure the newly created block gets the selection/drag handlers
            try{ setupBlockSelection && setupBlockSelection(); }catch(e){ console.warn('setupBlockSelection failed for new block', e); }
            // quitar la clase appear despu√©s de la animaci√≥n
            setTimeout(()=>{ try{ block.classList.remove('appear'); }catch(e){} }, 420);
            // peque√±o pulso visual en la columna
            try{ col.animate([{ transform: 'scale(1)' },{ transform: 'scale(1.02)' }, { transform: 'scale(1)'}], { duration: 260, easing: 'ease-out' }); }catch(e){}
            status.textContent = `Agregado parcial a ${name}. Total: ${col.querySelectorAll('.block').length}`;
            checkEmptyLines();
            // persist change so it survives reloads
            try{ saveState(); }catch(e){ /* ignore */ }
            // re-apply requested map just in case
            try{ applyRequestedToDOM(); }catch(e){}
            
            // ‚úÖ SINCRONIZAR CON FIREBASE - Esperar un poco para que el DOM est√© actualizado
            setTimeout(async () => {
                try{
                    // Esperar a que Firebase est√© inicializado
                    if(window.firebaseInitPromise){
                        await window.firebaseInitPromise;
                    }
                    
                    const kanbanState = getCurrentKanbanState();
                    console.log('üì§ Enviando estado a Firebase:', kanbanState);
                    
                    if(window.FirebaseSync && window.FirebaseSync.updateKanbanState){
                        const result = await window.FirebaseSync.updateKanbanState(kanbanState);
                        console.log('‚úÖ Resultado de sincronizaci√≥n:', result);
                    } else {
                        console.warn('‚ö† FirebaseSync no disponible');
                    }
                }catch(e){
                    console.error('‚ùå Error sincronizando con Firebase:', e);
                }
            }, 100);
        }

        async function removePartial(name){
            const col = findColumn(name);
            if(!col){
                status.textContent = `L√≠nea "${name}" no encontrada.`;
                return;
            }
            if(col.classList.contains('inactive')){
                status.textContent = `L√≠nea "${name}" est√° inactiva. No se pueden quitar parciales.`;
                return;
            }
            const blocks = col.querySelectorAll('.block');
            if(blocks.length === 0){
                status.textContent = `No hay parciales para eliminar en ${name}.`;
                return;
            }
            const last = blocks[blocks.length-1];
            // animar eliminaci√≥n y luego remover
            last.classList.add('removing');
            setTimeout(()=>{
                try{ last.remove(); }catch(e){}
                status.textContent = `Eliminado parcial de ${name}. Restan: ${col.querySelectorAll('.block').length}`;
                checkEmptyLines();
                // persist change so it survives reloads
                try{ saveState(); rebuildBlockNamesFromDOM(); }catch(e){ /* ignore */ }
            }, 260);
        }

        btnAdd.addEventListener('click', ()=>{
            // Open modal to allow manual naming via scanner or quick add
            openBarcodeModal(input.value);
        });

        btnRemove.addEventListener('click', async ()=>{
            try{
                const lineName = (input.value||'').trim();
                if(lineName){
                    // capture last block info for history BEFORE removing
                    const col = findColumn(lineName);
                    let lastInfo = null;
                    if(col){
                        const blocks = col.querySelectorAll('.block');
                        if(blocks.length > 0){
                            const last = blocks[blocks.length-1];
                            const idx = parseInt(last.getAttribute('data-index')||'-1',10);
                            const name = last.getAttribute('data-name') || ((last.querySelector('.label')||{}).textContent||'').trim();
                            lastInfo = { line: lineName, index: idx, name };
                        }
                    }

                    // compute duration based on existing solicitud timestamp and save history entry
                    const now = Date.now();
                    let solicitudMap = {};
                    try{ solicitudMap = JSON.parse(localStorage.getItem('pk_solicitud_salida')||'{}'); }catch(e){ solicitudMap = {}; }
                    let history = [];
                    try{ history = JSON.parse(localStorage.getItem('pk_history')||'[]'); }catch(e){ history = []; }
                    if(lastInfo){
                        const prevSolic = solicitudMap[lastInfo.line] && solicitudMap[lastInfo.line].solicitud ? parseInt(solicitudMap[lastInfo.line].solicitud,10) : null;
                        const duration = prevSolic ? Math.max(0, now - prevSolic) : 0;
                        try{ addHistoryEntries([{ name: lastInfo.name || (lastInfo.line + '#' + lastInfo.index), line: lastInfo.line, index: lastInfo.index, requestedAt: prevSolic || now, suppliedAt: now, duration }]); }catch(e){}
                    }

                    // Local removal only
                    removePartial(lineName);

                    // ‚úÖ SINCRONIZAR ELIMINACI√ìN CON FIREBASE - Esperar a que se complete la animaci√≥n
                    setTimeout(async () => {
                        try{
                            // Esperar a que Firebase est√© inicializado
                            if(window.firebaseInitPromise){
                                await window.firebaseInitPromise;
                            }
                            
                            const kanbanState = getCurrentKanbanState();
                            console.log('üì§ Enviando estado actualizado a Firebase:', kanbanState);
                            
                            if(window.FirebaseSync && window.FirebaseSync.updateKanbanState){
                                const result = await window.FirebaseSync.updateKanbanState(kanbanState);
                                console.log('‚úÖ Resultado de eliminaci√≥n:', result);
                            } else {
                                console.warn('‚ö† FirebaseSync no disponible');
                            }
                        }catch(e){
                            console.error('‚ùå Error sincronizando eliminaci√≥n:', e);
                        }
                    }, 300); // Esperar a que se complete la animaci√≥n de removePartial

                    // Mostrar notificaci√≥n de √©xito DESPU√âS de la animaci√≥n de removePartial (260ms)
                    setTimeout(()=>{
                        try{ 
                            status.style.display = 'block';
                            status.textContent = '‚úÖ Parcial abastecido correctamente'; 
                            alert('‚úÖ Parcial abastecido correctamente');
                            setTimeout(()=>{ 
                                status.textContent = ''; 
                                status.style.display = 'none';
                            }, 3000); 
                        }catch(e){}
                    }, 300);
                }
            }catch(e){ console.error('btnRemove error', e); }
            input.focus();
        });

        // enter key in input triggers add
        input.addEventListener('keydown', (e)=>{
            if(e.key === 'Enter'){
                e.preventDefault();
                addPartial(input.value);
            }
        });

        /** RENDER / STORAGE SYNC **/
        // render columns from an array of {name, count, active}
        function renderColumns(lines){
            const container = document.querySelector('.container');
            if(!container) return;
            container.innerHTML = '';
            lines.forEach((line, idx) => {
                const col = document.createElement('div');
                col.className = 'column';
                if(line.active === false){
                    col.classList.add('inactive');
                }
                // toggle switch for activate/deactivate
                const toggle = document.createElement('button');
                toggle.className = 'toggle-switch';
                if(line.active !== false) toggle.classList.add('active');
                toggle.type = 'button';
                toggle.title = line.active !== false ? 'Clic para desactivar' : 'Clic para activar';
                toggle.addEventListener('click', async (e)=>{
                    e.stopPropagation();
                    try{
                        // flip active flag for this line
                        lines[idx].active = !(lines[idx].active === false);
                        // persist
                        try{ localStorage.setItem('pk_lines', JSON.stringify(lines)); }catch(err){ console.error('failed saving pk_lines', err); }
                        // re-render columns from updated lines
                        try{ renderColumns(lines); }catch(err){ console.warn('re-render after toggle failed', err); }
                        // notify other listeners/tabs
                        try{ window.dispatchEvent(new StorageEvent('storage', {key:'pk_lines'})); }catch(e){ }
                    }catch(err){ console.error('toggle failed', err); }
                });
                col.appendChild(toggle);
                
                const h = document.createElement('div');
                h.className = 'column-header';
                h.textContent = line.name;
                // add a small timer element under the header to show solicitud/salida durations
                const timer = document.createElement('div');
                timer.className = 'sol-timer';
                timer.textContent = '';
                col.appendChild(h);
                col.appendChild(timer);
                if(line.active === false){
                    const badge = document.createElement('div');
                    badge.className = 'inactive-badge';
                    badge.textContent = 'INACTIVA';
                    col.appendChild(badge);
                }
                for(let i=0;i< (line.count||0); i++){
                    const b = document.createElement('div');
                    b.className = 'block';
                    // mark which line and index this block belongs to so we can persist "requested" state
                    b.setAttribute('data-line', line.name);
                    b.setAttribute('data-index', String(i));
                    // if we have a saved name for this block, set it
                    try{
                        const namesMap = JSON.parse(localStorage.getItem('pk_block_names')||'{}');
                        const nm = namesMap[line.name] && namesMap[line.name][String(i)];
                        if(nm){ b.setAttribute('data-name', nm); const span = document.createElement('span'); span.className='label'; span.textContent = nm; b.appendChild(span); }
                    }catch(e){}
                    // if this block index is present in requested map, add requested class
                    try{
                        const reqRaw = localStorage.getItem('pk_requested') || '{}';
                        const reqMap = reqRaw ? JSON.parse(reqRaw) : {};
                        const arr = Array.isArray(reqMap[line.name]) ? reqMap[line.name] : [];
                        if(arr.indexOf(i) !== -1) b.classList.add('requested');
                    }catch(e){ }
                    col.appendChild(b);
                }
                container.appendChild(col);
            });
            // re-run header click setup so newly rendered headers are interactive
            setupHeaderClicks && setupHeaderClicks();
            setupBlockSelection && setupBlockSelection();
            populateDatalist && populateDatalist();
            checkEmptyLines && checkEmptyLines();

            

            // ADJUST container width so the white background expands to fit the columns
            try{
                // remove CSS max-width restriction so we can size freely
                container.style.maxWidth = 'none';
                const cols = container.querySelectorAll('.column');
                if(cols.length > 0){
                    const first = cols[0];
                    // measure a single column's rendered width
                    const colW = first.offsetWidth || (parseFloat(getComputedStyle(first).minWidth) || 122);
                    const gap = parseFloat(getComputedStyle(container).gap) || 9;
                    const cs = getComputedStyle(container);
                    const padL = parseFloat(cs.paddingLeft) || 0;
                    const padR = parseFloat(cs.paddingRight) || 0;
                    // use fluid width so columns distribute across available viewport
                    container.style.maxWidth = '100%';
                    container.style.width = '100%';
                }
            }catch(e){ console.warn('renderColumns: width adjust failed', e); }
        }

        // Persist current DOM state (name + count + active) to localStorage so changes survive reload
        function getStateFromDOM(){
            try{
                const cols = Array.from(document.querySelectorAll('.container > .column'));
                return cols.map(c => {
                    const name = (c.querySelector('.column-header')||{textContent:''}).textContent.trim();
                    const count = c.querySelectorAll('.block').length;
                    const active = !c.classList.contains('inactive');
                    return { name, count, active };
                });
            }catch(e){ console.error('getStateFromDOM', e); return []; }
        }

        // Get kanban state in Firebase format (lineName -> [parcial1, parcial2, ...])
        function getCurrentKanbanState(){
            try{
                const kanbanState = {};
                const cols = Array.from(document.querySelectorAll('.container > .column'));
                const blockNamesMap = JSON.parse(localStorage.getItem('pk_block_names')||'{}');
                
                cols.forEach(col => {
                    const lineName = (col.querySelector('.column-header')||{textContent:''}).textContent.trim();
                    const blocks = Array.from(col.querySelectorAll('.block'));
                    const parciales = blocks.map((b, idx) => {
                        const blockName = b.getAttribute('data-name') || 
                                         (blockNamesMap[lineName] && blockNamesMap[lineName][String(idx)]) ||
                                         (b.querySelector('.label')||{}).textContent || 
                                         `Parcial ${idx+1}`;
                        return blockName;
                    });
                    if(parciales.length > 0){
                        kanbanState[lineName] = parciales;
                    } else {
                        kanbanState[lineName] = [];
                    }
                });
                
                return kanbanState;
            }catch(e){ 
                console.error('getCurrentKanbanState', e); 
                return {}; 
            }
        }

        // Requested parciales persistence helpers
        function getRequestedMap(){
            try{ return JSON.parse(localStorage.getItem('pk_requested')||'{}'); }catch(e){ return {}; }
        }
        function saveRequestedMap(map){
            try{ localStorage.setItem('pk_requested', JSON.stringify(map)); }catch(e){}
        }
        // ensure requested classes are applied to blocks currently in the DOM
        function applyRequestedToDOM(){
            try{
                const map = getRequestedMap();
                const blocks = document.querySelectorAll('.container .column .block');
                blocks.forEach(b => {
                    const line = b.getAttribute('data-line') || ((b.closest('.column')||{}).querySelector('.column-header')||{textContent:''}).textContent.trim();
                    const idx = parseInt(b.getAttribute('data-index')||'-1',10);
                    if(line && Number.isFinite(idx)){
                        const arr = Array.isArray(map[line]) ? map[line] : [];
                        if(arr.indexOf(idx) !== -1) b.classList.add('requested'); else b.classList.remove('requested');
                    }
                });
            }catch(e){}
        }

        // Ensure each column has a sol-timer element for showing solicitud/salida durations
        function ensureTimerElements(){
            try{
                console.log('ensureTimerElements: scanning columns for .sol-timer');
                const cols = Array.from(document.querySelectorAll('.container > .column'));
                cols.forEach(col => {
                    if(!col.querySelector('.sol-timer')){
                        const timer = document.createElement('div');
                        timer.className = 'sol-timer';
                        timer.textContent = '';
                        // insert after header if header exists
                        const hdr = col.querySelector('.column-header');
                        if(hdr && hdr.nextSibling) col.insertBefore(timer, hdr.nextSibling);
                        else if(hdr) col.appendChild(timer);
                        else col.insertBefore(timer, col.firstChild);
                        console.log('ensureTimerElements: created .sol-timer for', (hdr||{}).textContent);
                    }
                });
            }catch(e){ console.error('ensureTimerElements error', e); }
        }

        // Rebuild pk_requested from DOM requested classes (keeps indices consistent after removals)
        function rebuildRequestedFromDOM(){
            try{
                const map = {};
                const blocks = document.querySelectorAll('.container .column .block.requested');
                blocks.forEach(b => {
                    try{
                        const line = (b.getAttribute('data-line') || ((b.closest('.column')||{}).querySelector('.column-header')||{textContent:''}).textContent).trim();
                        const idx = parseInt(b.getAttribute('data-index')||'-1',10);
                        if(!line || !Number.isFinite(idx) || idx < 0) return;
                        map[line] = map[line] || [];
                        map[line].push(idx);
                    }catch(e){}
                });
                Object.keys(map).forEach(k=> map[k].sort((a,b)=>a-b));
                try{ localStorage.setItem('pk_requested', JSON.stringify(map)); }catch(e){}
                return map;
            }catch(e){ return {}; }
        }

        // Rebuild pk_block_names from DOM (used after removals or reindexing)
        function rebuildBlockNamesFromDOM(){
            try{
                const map = {};
                const cols = Array.from(document.querySelectorAll('.container > .column'));
                cols.forEach(col => {
                    const line = (col.querySelector('.column-header')||{textContent:''}).textContent.trim();
                    if(!line) return;
                    const blocks = Array.from(col.querySelectorAll('.block'));
                    blocks.forEach((b,i)=>{
                        const nm = b.getAttribute('data-name') || ((b.querySelector('.label')||{}).textContent||'').trim();
                        if(nm) {
                            map[line] = map[line] || {};
                            map[line][String(i)] = nm;
                            // ensure data-index up to date
                            b.setAttribute('data-index', String(i));
                            b.setAttribute('data-line', line);
                        }
                    });
                });
                try{ localStorage.setItem('pk_block_names', JSON.stringify(map)); }catch(e){}
                return map;
            }catch(e){ return {}; }
        }

        // Barcode modal logic
        function openBarcodeModal(prefillLine){
            try{
                const modal = document.getElementById('barcode-modal');
                const lineInput = document.getElementById('barcode-line-input');
                const scanInput = document.getElementById('barcode-input');
                const list = document.getElementById('barcode-scan-list');
                if(!modal || !scanInput) return;
                modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
                if(prefillLine) lineInput.value = prefillLine;
                list.innerHTML = '';
                scanInput.value = '';
                scanInput.focus();

                function addScanned(name){
                    const lineName = (lineInput.value||'').trim() || input.value;
                    if(!lineName) { alert('Selecciona o escribe la l√≠nea antes.'); return; }
                    // add a new partial with this name
                    addPartial(lineName, name);
                    try{ ensureBlockDataAttributes(); rebuildBlockNamesFromDOM(); applyRequestedToDOM(); ensureTimerElements(); }catch(e){}
                    // close modal immediately after adding
                    try{ closeModal(); }catch(err){ /* closeModal is defined below */ }
                }

                function onKey(e){
                    if(e.key === 'Enter'){
                        const val = scanInput.value.trim();
                        if(val) { addScanned(val); scanInput.value = ''; }
                        e.preventDefault();
                    }
                }

                scanInput.addEventListener('keydown', onKey);

                // populate lines list inside the details so user can pick existing line quickly
                try{
                    const ul = document.getElementById('barcode-lines-ul');
                    ul.innerHTML = '';
                    // prefer stored pk_lines, fallback to DOM
                    let lines = [];
                    try{ lines = JSON.parse(localStorage.getItem('pk_lines')||'[]'); }catch(e){}
                    if(!Array.isArray(lines) || lines.length === 0){
                        try{ lines = Array.from(document.querySelectorAll('.container > .column')).map(c => ({ name: (c.querySelector('.column-header')||{textContent:''}).textContent.trim() })); }catch(e){}
                    }
                    lines.forEach(l => {
                        const li = document.createElement('li');
                        li.textContent = (l && l.name) ? l.name : (typeof l === 'string' ? l : '');
                        li.style.padding = '6px';
                        li.style.cursor = 'pointer';
                        li.addEventListener('click', ()=>{ document.getElementById('barcode-line-input').value = li.textContent; document.getElementById('barcode-input').focus(); try{ const d = document.getElementById('barcode-lines-list'); if(d && d.open) d.open = false; }catch(e){} });
                        ul.appendChild(li);
                    });
                }catch(e){ }

                // cancel
                const cancel = document.getElementById('barcode-cancel');
                const closeModal = function(){ try{ scanInput.removeEventListener('keydown', onKey); }catch(e){}; modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); try{ input.focus(); }catch(e){} };
                function onCancel(){ closeModal(); }
                cancel && cancel.addEventListener('click', onCancel);
            }catch(e){ console.error('openBarcodeModal failed', e); }
        }

        function formatDurationShort(ms){
            if(!ms || ms < 0) return '0s';
            const s = Math.floor(ms/1000);
            const hh = Math.floor(s/3600); const mm = Math.floor((s%3600)/60); const ss = s%60;
            if(hh>0) return `${hh}h ${mm}m ${ss}s`;
            if(mm>0) return `${mm}m ${ss}s`;
            return `${ss}s`;
        }

        // Update per-column timers based on pk_solicitud_salida entries
        function updateColumnTimers(){
            try{
                const map = JSON.parse(localStorage.getItem('pk_solicitud_salida')||'{}');
                console.log('updateColumnTimers: map keys', Object.keys(map));
                const cols = Array.from(document.querySelectorAll('.container > .column'));
                cols.forEach(col => {
                    const name = (col.querySelector('.column-header')||{textContent:''}).textContent.trim();
                    const timerEl = col.querySelector('.sol-timer');
                    if(!timerEl) return;
                    const entry = map[name];
                    if(entry && entry.solicitud){
                        const solicitud = parseInt(entry.solicitud,10) || 0;
                        const salida = entry.salida ? (parseInt(entry.salida,10)||0) : 0;
                        if(solicitud && !salida){
                            timerEl.textContent = 'Solicitado: ' + formatDurationShort(Date.now() - solicitud);
                            try{ console.log('updateColumnTimers active:', name, Date.now() - solicitud); }catch(e){}
                        } else if(solicitud && salida){
                            timerEl.textContent = 'Tiempo: ' + formatDurationShort(salida - solicitud);
                        } else timerEl.textContent = '';
                    } else {
                        timerEl.textContent = '';
                    }
                });
            }catch(e){ console.error('updateColumnTimers error', e); }
        }

        // start interval to refresh column timers (and keep a quick initial update)
        try{
            console.log('starting column timers interval');
            // store interval id in window for debugging/ability to clear
            window._colTimersInterval = setInterval(()=>{ try{ ensureTimerElements(); updateColumnTimers(); }catch(e){ console.error('timer interval error', e); } }, 1000);
            console.log('column timers interval id:', window._colTimersInterval);
        }catch(e){ console.error('failed to start timers interval', e); }

        // expose functions for manual debugging in console
        try{ window.ensureTimerElements = ensureTimerElements; window.updateColumnTimers = updateColumnTimers; }catch(e){ }
        // expose requested-map helpers to other scripts (they run in separate script blocks)
        try{ window.getRequestedMap = getRequestedMap; window.saveRequestedMap = saveRequestedMap; window.applyRequestedToDOM = applyRequestedToDOM; window.ensureBlockDataAttributes = ensureBlockDataAttributes; }catch(e){ }

        // Ensure existing static DOM blocks have `data-line` and `data-index` attributes
        function ensureBlockDataAttributes(){
            try{
                const cols = Array.from(document.querySelectorAll('.container > .column'));
                cols.forEach(col => {
                    const lineName = (col.querySelector('.column-header')||{textContent:''}).textContent.trim();
                    const blocks = Array.from(col.querySelectorAll('.block'));
                    blocks.forEach((b, i) => {
                        if(!b.hasAttribute('data-line')) b.setAttribute('data-line', lineName);
                        if(!b.hasAttribute('data-index')) b.setAttribute('data-index', String(i));
                    });
                });
            }catch(e){}
        }

        function saveState(){
            try{
                const state = getStateFromDOM();
                localStorage.setItem('pk_lines', JSON.stringify(state));
                // no need to dispatch storage event here; other tabs will receive native event
            }catch(e){ console.error('saveState', e); }
        }

        // load lines from localStorage and render
        function loadLinesFromStorage(){
            try{
                const raw = localStorage.getItem('pk_lines');
                if(!raw) return false;
                const lines = JSON.parse(raw);
                if(Array.isArray(lines)){
                    renderColumns(lines);
                    return true;
                }
            }catch(e){ console.error('loadLinesFromStorage', e); }
            return false;
        }

        // expose a helper so other scripts (manage panel) can apply lines directly without reloading
        window.applyLinesToDOM = function(lines){
            try{ renderColumns(lines); populateDatalist && populateDatalist(); setupHeaderClicks && setupHeaderClicks(); setupBlockSelection && setupBlockSelection(); checkEmptyLines && checkEmptyLines(); }catch(e){ console.warn('applyLinesToDOM failed', e); }
        };

        // listen to storage changes from manage page
        window.addEventListener('storage', (e)=>{
            if(e.key === 'pk_lines'){
                loadLinesFromStorage();
                try{ ensureBlockDataAttributes(); applyRequestedToDOM(); ensureTimerElements(); updateColumnTimers(); }catch(e){}
            }
            // if requested map changed in another tab, reapply requested state and timers
            if(e.key === 'pk_requested' || e.key === 'pk_solicitud_salida'){
                try{ ensureBlockDataAttributes(); applyRequestedToDOM(); ensureTimerElements(); updateColumnTimers(); }catch(e){}
            }
        });

        // initial attempt to load from storage; if none, keep static DOM
        loadLinesFromStorage();
        // ensure static DOM blocks have data attributes, then apply requested state and show timers
        try{ ensureBlockDataAttributes(); applyRequestedToDOM(); ensureTimerElements(); updateColumnTimers(); }catch(e){}

    });
    </script>
    <!-- Firebase removed -->
    <script>
    </script>

            <script>
            (function(){
        // Firebase removed - Local storage only
        console.log('Local storage mode enabled');
        try{
            window.saveState = function(){
                try{ if(typeof originalSave === 'function') originalSave(); }catch(e){ console.warn('original saveState failed', e); }
                try{ window.saveStateToRemote(); }catch(e){ console.warn('saveStateToRemote failed', e); }
            };
        }catch(e){ console.warn('hook saveState failed', e); }

        try{
            const originalSaveReq = window.saveRequestedMap;
            window.saveRequestedMap = function(map){
                try{ if(typeof originalSaveReq === 'function') originalSaveReq(map); }catch(e){ console.warn('original saveRequestedMap failed', e); }
                try{ saveStateToRemoteDebounced({ pk_requested: map || JSON.parse(localStorage.getItem('pk_requested')||'{}') }); }catch(e){ console.warn('remote saveRequestedMap failed', e); }
            };
        }catch(e){ console.warn('hook saveRequestedMap failed', e); }

        console.log('App initialized (Firebase removed).');
    })();
    </script>

    <script>
    // Renderizador de historial: consume objetos devueltos por Firestore
    (function(){
        function safeTxt(s){ return String(s||''); }
        function formatTs(ts){
            if(!ts) return '';
            try{
                if(typeof ts.toDate === 'function') ts = ts.toDate();
                else if(ts && ts.seconds) ts = new Date(ts.seconds * 1000);
                else if(typeof ts === 'number') ts = new Date(ts);
                if(ts instanceof Date) return ts.toLocaleString();
            }catch(e){}
            return String(ts||'');
        }

        function renderRecentHistory(items){
            try{
                const list = document.getElementById('recent-history-list');
                if(!list) return;
                list.innerHTML = '';
                if(!Array.isArray(items) || items.length === 0){
                    // show placeholder when no history entries exist
                    const p = document.createElement('li');
                    p.className = 'empty-history';
                    p.style.opacity = '0.5';
                    p.style.padding = '18px';
                    p.textContent = 'No hay entradas recientes en el historial.';
                    list.appendChild(p);
                    return;
                }
                // take up to 5 most recent
                const arr = items.slice(0,5);
                arr.forEach(it => {
                    const id = it.id || '';
                    const title = it.orderId || it.name || ('#' + (it.index!=null?it.index:''));
                    const action = it.action || (it.suppliedAt || it.suppliedAt===0 ? 'abastecido' : (it.requestedAt ? 'solicitado' : 'registro'));
                    const line = it.line || it.columnId || '';
                    const time = formatTs(it.ts || it.suppliedAt || it.requestedAt || it.createdAt);

                    const li = document.createElement('li');
                    li.dataset.id = id;
                    li.innerHTML = `
                        <div class="order-title">${escapeHtml(title)}</div>
                        <div class="item-row">
                            <div style="flex:1">${escapeHtml(action || '')}${line ? (' ‚Äî ' + escapeHtml(line)) : ''}</div>
                            <div style="font-size:12px;color:#6b7280">${escapeHtml(time)}</div>
                        </div>`;
                    list.appendChild(li);
                });
            }catch(e){ console.error('renderRecentHistory failed', e); }
        }

        // small helper to escape HTML in strings
        function escapeHtml(str){
            return String(str||'').replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]; });
        }

        // expose globally for listeners
        window.renderRecentHistory = renderRecentHistory;

        // test helper removed (Firebase dependency)

        // if page doesn't include a full historialModule, provide a small fallback implementation
        if(!window.historialModule){
            window.historialModule = {
                setRemoteData(items){ try{ renderRecentHistory(items); }catch(e){ console.warn(e); } },
                renderizar(){ try{ /* nothing ‚Äî remote data will trigger setRemoteData */ }catch(e){} }
            };
        }
    })();
    </script>
    <!-- Barcode / naming modal -->
    <div id="barcode-modal" class="barcode-modal" aria-hidden="true">
        <h3>Abastecer Kamban ‚Äî escanea o escribe nombre</h3>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <input id="barcode-line-input" type="text" placeholder="L√≠nea (ej. PK1)" style="flex:1;padding:8px;border:1px solid rgba(0,0,0,0.08);border-radius:6px" />
        </div>
        <details id="barcode-lines-list" style="margin-top:8px">
            <summary style="cursor:pointer;font-weight:700">L√≠neas existentes</summary>
            <ul id="barcode-lines-ul" style="list-style:none;padding:6px;margin:6px 0;max-height:160px;overflow:auto"></ul>
        </details>
        <div style="margin-top:8px">Escanea la orden de producci√≥n</div>
        <input id="barcode-input" type="text" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);margin-top:6px;font-size:16px" placeholder="Escanea la orden de producci√≥n" />
        <div class="scan-list" id="barcode-scan-list"></div>
        <div class="modal-actions">
            <button id="barcode-cancel" class="btn" style="margin-left:auto">Cancelar</button>
        </div>
    </div>
    <!-- debug modal removed per user request -->
    <script>
    // top-info helpers: update current datetime and durations list
    (function(){
        function fmtDateTime(d){
            try{ return d.toLocaleString(); }catch(e){ return (new Date()).toString(); }
        }

        function formatDuration(ms){
            if(ms < 1000) return 'justo ahora';
            let s = Math.floor(ms/1000);
            const days = Math.floor(s/86400); s-= days*86400;
            const hours = Math.floor(s/3600); s-= hours*3600;
            const minutes = Math.floor(s/60); s-= minutes*60;
            const parts = [];
            if(days) parts.push(days + 'd');
            if(hours) parts.push(hours + 'h');
            if(minutes) parts.push(minutes + 'm');
            if(s) parts.push(s + 's');
            return parts.join(' ');
        }

        function updateDateTime(){
            const dtEl = document.getElementById('current-datetime');
            if(dtEl) dtEl.textContent = fmtDateTime(new Date());
        }

        function updateEmptyDurationsDisplay(){
            const listEl = document.getElementById('empty-durations-list');
            if(!listEl) return;
            listEl.innerHTML = '';
            let map = {};
            try{ map = JSON.parse(localStorage.getItem('pk_empty_since')||'{}'); }catch(e){ map = {}; }
            const entries = Object.keys(map).map(k=> ({name:k, since: parseInt(map[k],10)||0}));
            entries.sort((a,b)=> (a.since||0) - (b.since||0));
            entries.forEach(e=>{
                const li = document.createElement('li');
                const dur = e.since ? formatDuration(Date.now() - e.since) : 'desconocido';
                li.textContent = `${e.name} ‚Äî ${dur}`;
                listEl.appendChild(li);
            });
        }

        function updateSolicitudDurationsDisplay(){
            const listEl = document.getElementById('empty-durations-list');
            if(!listEl) return;
            listEl.innerHTML = '';
            let map = {};
            try{ map = JSON.parse(localStorage.getItem('pk_solicitud_salida')||'{}'); }catch(e){ map = {}; }
            const entries = Object.keys(map)
                .filter(k => map[k] && map[k].solicitud)
                .map(k=> ({ name: k, solicitud: parseInt(map[k].solicitud,10)||0, salida: parseInt((map[k].salida||0),10)||0 }));
            entries.sort((a,b)=> (a.solicitud||0) - (b.solicitud||0));
            // show active requests (no salida) first in red
            const active = entries.filter(x => x.solicitud && !x.salida).sort((a,b)=> (a.solicitud||0) - (b.solicitud||0));
            active.forEach(e => {
                const li = document.createElement('li');
                li.className = 'current';
                const nameSpan = document.createElement('span'); nameSpan.className = 'name'; nameSpan.textContent = e.name;
                const timeSpan = document.createElement('span'); timeSpan.className = 'time'; timeSpan.textContent = e.solicitud ? formatDuration(Date.now() - e.solicitud) : 'justo ahora';
                li.appendChild(nameSpan);
                li.appendChild(timeSpan);
                listEl.appendChild(li);
            });

            // also show recently completed requests (show 0s) for a short grace period so the top card shows stopped time
            const RECENT_MS = 10000; // show completed entries for 10s
            const now = Date.now();
            const recent = entries.filter(x => x.salida && (now - x.salida) <= RECENT_MS).sort((a,b)=> (b.salida||0) - (a.salida||0));
            recent.forEach(e => {
                const li = document.createElement('li');
                li.className = 'stopped';
                const nameSpan = document.createElement('span'); nameSpan.className = 'name'; nameSpan.textContent = e.name;
                const timeSpan = document.createElement('span'); timeSpan.className = 'time';
                const dur = (e.solicitud && e.salida) ? formatDuration((e.salida||0) - e.solicitud) : '0s';
                timeSpan.textContent = dur;
                li.appendChild(nameSpan);
                li.appendChild(timeSpan);
                listEl.appendChild(li);
            });
        }

        // initial update and interval
        updateDateTime(); updateSolicitudDurationsDisplay();
        // nota: renderRecentHistory ahora es manejado por historial.js
        setInterval(()=>{ updateDateTime(); updateSolicitudDurationsDisplay(); }, 1000);

        // make top-info draggable & persistent (same UX as floating-history)
        (function(){
            const el = document.getElementById('top-info');
            if(!el) return;
            const key = 'pk_top_info_pos';
            function apply(){
                try{
                    if(window.matchMedia && window.matchMedia('(max-width:900px)').matches) return;
                    const raw = localStorage.getItem(key);
                    if(!raw) return;
                    const pos = JSON.parse(raw);
                    if(pos && typeof pos.left === 'number' && typeof pos.top === 'number'){
                        el.style.position = 'fixed';
                        el.style.left = Math.max(6, Math.min(window.innerWidth - (el.offsetWidth||170) - 6, pos.left)) + 'px';
                        el.style.top = Math.max(6, Math.min(window.innerHeight - (el.offsetHeight||48) - 6, pos.top)) + 'px';
                        el.style.right = 'auto';
                    }
                }catch(e){ console.warn('apply top-info', e); }
            }
            apply();

            let dragging=false, sx=0, sy=0, sl=0, st=0, pid=null;
            const handle = document.getElementById('top-info-handle');
            const resetBtn = document.getElementById('top-info-reset');
            function within(){ return !(window.matchMedia && window.matchMedia('(max-width:900px)').matches); }
            function onMove(e){ if(!dragging) return; const cx = e.clientX!==undefined?e.clientX:(e.touches&&e.touches[0]&&e.touches[0].clientX); const cy = e.clientY!==undefined?e.clientY:(e.touches&&e.touches[0]&&e.touches[0].clientY); if(cx==null||cy==null) return; let nx = Math.round(sl + (cx - sx)); let ny = Math.round(st + (cy - sy)); const pad=6; const w=el.offsetWidth||170; const h=el.offsetHeight||48; nx=Math.max(pad,Math.min(window.innerWidth-w-pad,nx)); ny=Math.max(pad,Math.min(window.innerHeight-h-pad,ny)); el.style.left = nx+'px'; el.style.top = ny+'px'; }
            function endDrag(e){ if(!dragging) return; dragging=false; el.classList.remove('dragging'); try{ localStorage.setItem(key, JSON.stringify({left: parseInt(el.style.left||0,10), top: parseInt(el.style.top||0,10)})); }catch(err){} document.removeEventListener('pointermove', onMove); document.removeEventListener('pointerup', endDrag); document.removeEventListener('touchmove', onMove); document.removeEventListener('touchend', endDrag); try{ if(pid && e.target && e.target.releasePointerCapture) e.target.releasePointerCapture(pid); }catch(e){} pid=null; }
            function startDrag(e){
                if(!within()) return;
                try{
                    const t = e.target || (e.touches && e.touches[0]);
                    const node = t && (t.nodeType ? t : t.target) || e.target;
                    if(node && node.closest){
                        // allow drag if the interaction originates from the drag-handle itself
                        const isHandle = !!node.closest('.drag-handle');
                        const isInteractive = !!node.closest('button, a, input, textarea, select, [role="button"]');
                        if(isInteractive && !isHandle) return; // if it's an interactive element but not the handle, ignore
                    }
                }catch(_){ }

                try{ el.style.zIndex = 9999; }catch(e){}

                e.preventDefault && e.preventDefault();
                dragging = true; el.classList.add('dragging');

                try{
                    // if element wasn't fixed before, convert its current position into fixed coords
                    if(getComputedStyle(el).position !== 'fixed'){
                        const r = el.getBoundingClientRect();
                        el.style.position = 'fixed';
                        el.style.left = (r.left + window.scrollX) + 'px';
                        el.style.top = (r.top + window.scrollY) + 'px';
                        el.style.right = 'auto';
                    }
                }catch(_){ }

                sx = e.clientX!==undefined?e.clientX:(e.touches&&e.touches[0]&&e.touches[0].clientX);
                sy = e.clientY!==undefined?e.clientY:(e.touches&&e.touches[0]&&e.touches[0].clientY);
                sl = parseInt(el.style.left||el.getBoundingClientRect().left||0,10);
                st = parseInt(el.style.top||el.getBoundingClientRect().top||0,10);
                pid = e.pointerId||null;
                try{ if(pid && e.target && e.target.setPointerCapture) e.target.setPointerCapture(pid); }catch(e){}

                document.addEventListener('pointermove', onMove);
                document.addEventListener('pointerup', endDrag);
                document.addEventListener('touchmove', onMove, { passive: false });
                document.addEventListener('touchend', endDrag);
            }
            if(handle){
                // prefer Pointer Events, fall back to mouse/touch
                handle.addEventListener('pointerdown', startDrag, { passive: false });
                handle.addEventListener('mousedown', startDrag, { passive: false });
                handle.addEventListener('touchstart', function(e){ e.preventDefault&&e.preventDefault(); startDrag(e); }, { passive:false });
            }
            // also allow grabbing the card itself (but avoid starting drag when clicking on interactive children)
            try{ el.addEventListener('pointerdown', startDrag, { passive:false }); el.addEventListener('mousedown', startDrag, { passive:false }); el.addEventListener('touchstart', function(e){ e.preventDefault&&e.preventDefault(); startDrag(e); }, { passive:false }); }catch(e){}
            if(resetBtn){ resetBtn.addEventListener('click', function(){ try{ localStorage.removeItem(key); el.style.left=''; el.style.top=''; el.style.position=''; el.style.right='18px'; el.style.top='18px'; }catch(e){} }); }
            window.addEventListener('resize', function(){ if(!within()) return; try{ const r = el.getBoundingClientRect(); const pad=6; const w=el.offsetWidth||170; const h=el.offsetHeight||48; let l=r.left, t=r.top; if(l + w > window.innerWidth - pad) l = Math.max(pad, window.innerWidth - w - pad); if(t + h > window.innerHeight - pad) t = Math.max(pad, window.innerHeight - h - pad); el.style.left = l+'px'; el.style.top = t+'px'; }catch(e){} });
        })();

        // expose for other code if needed
        window.updateEmptyDurationsDisplay = updateEmptyDurationsDisplay;
        window.updateSolicitudDurationsDisplay = updateSolicitudDurationsDisplay;

        // ‚úÖ Cargar datos de Firebase e inicializar listeners
        (async () => {
            try {
                console.log('üöÄ Inicializando Firebase despu√©s de DOMContentLoaded...');
                if(window.firebaseInitPromise){
                    await window.firebaseInitPromise;
                    console.log('‚úÖ Firebase inicializado');
                }
                
                // Cargar datos iniciales
                if(typeof loadAllDataFromFirebase === 'function'){
                    await loadAllDataFromFirebase();
                    console.log('‚úÖ Datos cargados desde Firebase');
                }
                
                // Iniciar listeners en tiempo real
                if(typeof initFirebaseSync === 'function'){
                    await initFirebaseSync();
                    console.log('‚úÖ Listeners de Firebase inicializados');
                }
            } catch(e) {
                console.error('‚ùå Error inicializando Firebase:', e);
            }
        })();
    });
    </script>

    <!-- Monitor y Historial -->
    <!-- <script src="monitor.js"></script> -->
    <!-- Historial module (gestiona y muestra el historial de √≥rdenes) -->
    <script src="historial.js"></script>
        <script>
            // Mostrar panel de control interno en vez de abrir nueva pesta√±a
            document.addEventListener('DOMContentLoaded', function(){
                const btn = document.getElementById('btn-panel-control');
                if(btn){
                    btn.addEventListener('click', (ev)=>{
                        ev.preventDefault && ev.preventDefault();
                        const panel = document.getElementById('panel-control-interno');
                        if(panel){
                            panel.style.display = 'block';
                            document.body.style.overflow = 'hidden';
                            // render content
                            if(typeof renderPanelContent === 'function') renderPanelContent();
                        } else {
                            // fallback: open existing page if internal panel not present
                            window.open('panel_control.html','_blank');
                        }
                    });
                }
            });
        </script>
    <!-- LAYOUT: Botones arriba, b√∫squeda/gestionar abajo-izq, l√≠neas derecha -->
    <div class="main-container">
        <!-- Fila superior: BOTONES -->
        <div class="top-controls">
            <button id="btn-entrada" class="color-box blue" type="button" aria-label="Abastecer Kamban">ABASTECER<br>KAMBAN</button>
            <button id="btn-salida" class="color-box green" type="button" aria-label="Abastecer AB">ABASTECER<br>AB</button>
            <button id="btn-anular-solicitud" class="color-box red" type="button" aria-label="Anular solicitud" style="background:linear-gradient(90deg,#ff6b6b,#ff5252);color:white;">ANULAR<br>SOLICITUD</button>
            <button id="btn-solicitar" class="color-box orange" type="button" aria-label="Solicitar parciales">SOLICITAR<br>PARCIALES</button>
            <button id="btn-panel-control" class="color-box purple" type="button" aria-label="Panel de control" style="background:linear-gradient(90deg,#7c3aed,#6d28d9);color:white;">PANEL<br>DE CONTROL</button>
            
            <!-- top-info compacta: fecha y resumen de tiempos (una l√≠nea) -->
            <div id="top-info" class="top-info top-info-compact" aria-live="polite" style="display:none !important;visibility:hidden">
                <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;width:100%">
                    <div style="display:flex;align-items:center;gap:8px">
                        <button id="top-info-handle" class="drag-handle" aria-label="Mover info" title="Mover" type="button">‚â°</button>
                        <div id="current-datetime" class="now">--</div>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px">
                        <button id="top-info-reset" class="history-reset" title="Resetear posici√≥n" aria-label="Resetear posici√≥n">‚§æ</button>
                    </div>
                    <div id="auth-controls" style="display:flex;align-items:center;gap:8px;margin-left:12px">
                        <div id="user-info" style="font-size:12px;color:#222;min-width:140px;text-align:right"></div>
                        <button id="btn-signin-google" class="btn" type="button" style="padding:6px 8px;font-size:12px">Entrar con Google</button>
                        <button id="btn-signout" class="btn" type="button" style="padding:6px 8px;font-size:12px;display:none">Cerrar sesi√≥n</button>
                    </div>
                    </div>
                </div>
                <div class="durations">
                    <!-- Panel de tiempos oculto por solicitud del usuario -->
                    <div style="display:none !important">Gestion (S‚ÜíS):</div>
                    <ul id="empty-durations-list" style="display:none !important"></ul>
                </div>
            </div>
        </div>
        <!-- Contenedor inferior: b√∫squeda izq, l√≠neas der -->
        <div class="bottom-container">
            <!-- Panel izquierdo: b√∫squeda y gestionar -->
            <div class="controls">
                <!-- 'NOMBRE DE LA L√çNEA' y buscador removidos por petici√≥n del usuario. -->
                <!-- Mantener un input oculto con id 'line-name' para compatibilidad con el JS existente. -->
                <input id="line-name" type="text" value="" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;border:0;padding:0;margin:0" aria-hidden="true" />
                <div id="control-status" class="status" aria-live="polite" style="font-size:11px;color:#333;display:none"></div>
                <!-- moved info panel (fecha y duraciones) -->
                        <!-- top-info movido a la tarjeta flotante para agrupar historial y duraciones -->
                <!-- Historial y buscador se han movido a la tarjeta flotante (floating-history) para mejor colocaci√≥n visual -->
            </div>
            <!-- Panel izquierdo: l√≠neas y parciales -->
            <div class="right-panel">
                <div class="container">
        <div class="column">
            <div class="column-header">PKB1</div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
        </div>
        <div class="column">
            <div class="column-header">PKB2</div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
        </div>
        <div class="column">
            <div class="column-header">PKB3</div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
        </div>
        <div class="column">
            <div class="column-header">PKB4</div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
        </div>
        <div class="column">
            <div class="column-header">PKB5</div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
        </div>
        <div class="column">
            <div class="column-header">PKB6</div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
        </div>
        <div class="column">
            <div class="column-header">JVH2</div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
        </div>
        <div class="column">
            <div class="column-header">EYS</div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
        </div>
        <div class="column">
            <div class="column-header">MAQ</div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
            <div class="block"></div>
        </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // attach manage button behavior (runs after controls exist)
        (function(){
            const btn = document.getElementById('manage-lines-btn');
            const panel = document.getElementById('manage-panel');
            const closeBtn = document.getElementById('m-btn-close');
            if(!btn || !panel) return;
            function openPanel(){ panel.classList.add('open'); panel.setAttribute('aria-hidden','false'); }
            function closePanel(){ panel.classList.remove('open'); panel.setAttribute('aria-hidden','true'); }
            btn.addEventListener('click', ()=>{ openPanel(); });
            closeBtn && closeBtn.addEventListener('click', closePanel);
            // close on Escape
            window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closePanel(); });
        })();
    </script>

    <script>
    // buscador de √≥rdenes: filtra y resalta bloques que contienen el texto buscado
    (function(){
        const input = document.getElementById('order-search');
        const clearBtn = document.getElementById('order-search-clear');
        if(!input) return;

        function normalize(s){ return String(s||'').trim().toLowerCase(); }

        function applyFilter(){
            const q = normalize(input.value);
            const historyItems = Array.from(document.querySelectorAll('#recent-history-list li'));
            let firstHistMatch = null;
            if(!q){
                historyItems.forEach(li => li.classList.remove('history-dim','history-match'));
                return;
            }
            // search history list only
            historyItems.forEach(li =>{
                const text = normalize(li.textContent || li.innerText || '');
                if(text.indexOf(q) !== -1){
                    li.classList.add('history-match');
                    li.classList.remove('history-dim');
                    if(!firstHistMatch) firstHistMatch = li;
                } else {
                    li.classList.add('history-dim');
                    li.classList.remove('history-match');
                }
            });
            // scroll first history match into view
            if(firstHistMatch){
                try{ firstHistMatch.scrollIntoView({ behavior: 'smooth', block: 'center' }); }catch(e){}
            }
        }

        input.addEventListener('input', applyFilter);
        input.addEventListener('search', applyFilter);
        clearBtn && clearBtn.addEventListener('click', ()=>{ input.value=''; input.focus(); applyFilter(); });

        // expose for debugging
        window.pkFilterOrders = applyFilter;

        // attach export buttons (if module exists later, they'll call it)
        function attachExportButtons(){
            const btnCsv = document.getElementById('export-history-csv');
            const btnJson = document.getElementById('export-history-json');
            const btnJsonStorage = document.getElementById('export-json-btn');
            if(btnCsv){ btnCsv.addEventListener('click', ()=>{ if(window.historialModule && window.historialModule.exportCSV) window.historialModule.exportCSV(); else alert('M√≥dulo historial no disponible a√∫n. Intenta de nuevo.'); }); }
            if(btnJson){ btnJson.addEventListener('click', ()=>{ if(window.historialModule && window.historialModule.exportar) window.historialModule.exportar(); else alert('M√≥dulo historial no disponible a√∫n. Intenta de nuevo.'); }); }
            if(btnJsonStorage){
                btnJsonStorage.addEventListener('click', ()=>{
                    if(window.JSONStorage){
                        window.JSONStorage.saveAll();
                        alert('‚úÖ Datos guardados. Descargando archivos JSON...');
                        setTimeout(()=>{ window.JSONStorage.downloadAllJSONs(); }, 500);
                    } else {
                        alert('Sistema JSON no disponible. Recarga la p√°gina.');
                    }
                });
            }
        }
        // intentar conectar inmediatamente y tambi√©n tras carga completa
        attachExportButtons();
        window.addEventListener('DOMContentLoaded', attachExportButtons);
    })();
    // navegaci√≥n por el historial: mostrar solo una entrada y permitir avanzar/retroceder
    (function(){
        const list = document.getElementById('recent-history-list');
        const prev = document.getElementById('recent-prev');
        const next = document.getElementById('recent-next');
        if(!list) return;

        // hacer la lista enfocables para accesibilidad
        try{ list.tabIndex = 0; }catch(e){}

        function getStep(){
            // navegar exactamente por la altura del contenedor (una tarjeta completa)
            return list.clientHeight || 170;
        }

        function stepScroll(dir){
            const step = getStep();
            list.scrollBy({ top: dir * step, behavior: 'smooth' });
        }

        prev && prev.addEventListener('click', ()=> stepScroll(-1));
        next && next.addEventListener('click', ()=> stepScroll(1));

        // teclas cuando la lista tiene foco
        list.addEventListener('keydown', (e)=>{
            if(e.key === 'ArrowDown'){ e.preventDefault(); stepScroll(1); }
            if(e.key === 'ArrowUp'){ e.preventDefault(); stepScroll(-1); }
        });

        // mostrar/ocultar controles si hay 0 o 1 items
        const nav = document.querySelector('#recent-history .recent-nav');
        function adjustNavVisibility(){
            const items = Array.from(list.querySelectorAll('li'));
            if(!nav) return;
            // Deshabilitado: navegaci√≥n solo con mouse (scroll)
            nav.style.display = 'none'; 
        }

        const obs = new MutationObserver(adjustNavVisibility);
        obs.observe(list, { childList: true, subtree: false });
        // run once now in case items are already present
        adjustNavVisibility();
    })();

    // Posicionar el panel de historial de forma segura para evitar solapamientos
    (function(){
        const history = document.getElementById('floating-history');
        if(!history) return;

        function positionHistory(){
            // en pantallas peque√±as dejamos la posici√≥n est√°tica (CSS media query ya maneja esto)
            if(window.matchMedia && window.matchMedia('(max-width:900px)').matches){
                history.style.position = '';
                history.style.left = '';
                history.style.top = '';
                history.style.right = '';
                return;
            }

            const topControls = document.querySelector('.top-controls');
            const actions = document.getElementById('floating-actions');

            let left = 18 + window.scrollX;
            // si hay acciones flotantes a la izquierda, colocamos el historial a su derecha
            if(actions){
                try{ left = Math.round(actions.getBoundingClientRect().right) + 12 + window.scrollX; }catch(e){}
            }

            // if the history panel has been explicitly locked to a fixed position, avoid repositioning it
            try{
                if(history && history.dataset && history.dataset.fixed === 'true') return;
            }catch(e){}

            // colocamos el historial justo debajo de la fila superior (top-controls)
            let top = 18 + window.scrollY;
            if(topControls){
                try{ top = Math.round(topControls.getBoundingClientRect().bottom) + 10 + window.scrollY; }catch(e){}
            }

            // asegurar que no salga del viewport por la derecha
            const w = Math.min(history.offsetWidth || 300, 360);
            if(left + w > window.innerWidth - 18){ left = Math.max(18, window.innerWidth - w - 18); }

            history.style.position = 'fixed';
            history.style.left = left + 'px';
            history.style.top = top + 'px';
            history.style.right = 'auto';
            history.style.zIndex = 115;
        }

        // recalcular en eventos clave
        window.addEventListener('resize', positionHistory);
        window.addEventListener('scroll', positionHistory);
        window.addEventListener('DOMContentLoaded', positionHistory);
        // run once now
        setTimeout(positionHistory, 40);

        // --- floating-history behavior: can be draggable/persisted OR fixed ---
        (function(){
            // toggle this to true if later you want the history panel draggable again
            const FLOATING_HISTORY_DRAGGABLE = false;
            // If you want this panel locked to an exact viewport position, set fixed coords here
            // (left, top) in pixels. Set to null to let positionHistory compute a place automatically.
            // moved a bit higher as requested
            const FLOATING_HISTORY_FIXED_POS = { left: 380, top: 10 };
            const key = 'pk_floating_history_pos';
               const el = document.getElementById('floating-history');
            if(!el) return;

            // apply persisted position if present and screen is wide enough
            function applySaved(){
                try{
                    if(window.matchMedia && window.matchMedia('(max-width:900px)').matches) return; // ignore mobile
                    const raw = localStorage.getItem(key);
                    if(!raw) return;
                    const pos = JSON.parse(raw);
                    if(pos && typeof pos.left === 'number' && typeof pos.top === 'number'){
                        el.style.position = 'fixed';
                        el.style.left = Math.max(8, Math.min(window.innerWidth - (el.offsetWidth||300) - 8, pos.left)) + 'px';
                        el.style.top = Math.max(8, Math.min(window.innerHeight - (el.offsetHeight||150) - 8, pos.top)) + 'px';
                        el.style.right = 'auto';
                    }
                }catch(e){ console.warn('applySaved pos failed', e); }
            }
            // if we're using draggable mode apply previously saved position, otherwise keep fixed layout
            if(FLOATING_HISTORY_DRAGGABLE){
                // initial apply on load
                applySaved();
            } else {
                // clear any previously stored position so old values don't move the panel
                try{ localStorage.removeItem(key); }catch(e){}
                // if a fixed position was requested, apply it exactly; otherwise use the default placement
                try{
                    if(FLOATING_HISTORY_FIXED_POS && typeof FLOATING_HISTORY_FIXED_POS.left === 'number'){
                        el.style.position = 'fixed';
                        el.style.left = Math.max(8, Math.min(window.innerWidth - (el.offsetWidth||300) - 8, FLOATING_HISTORY_FIXED_POS.left)) + 'px';
                        el.style.top = Math.max(8, Math.min(window.innerHeight - (el.offsetHeight||150) - 8, FLOATING_HISTORY_FIXED_POS.top)) + 'px';
                        el.style.right = 'auto';
                        el.style.zIndex = 115;
                        // mark as fixed so positionHistory won't move it later
                        try{ el.dataset.fixed = 'true'; }catch(e){}
                    } else { positionHistory(); }
                }catch(e){ positionHistory(); }
            }

            let dragging = false; let startX=0, startY=0, startLeft=0, startTop=0, pointerId=null;

            const handle = el.querySelector('.drag-handle');
            const resetBtn = document.getElementById('floating-history-reset');

            function withinDesktop(){ return !(window.matchMedia && window.matchMedia('(max-width:900px)').matches); }

            function onPointerMove(e){
                if(!dragging) return;
                const clientX = e.clientX !== undefined ? e.clientX : (e.touches && e.touches[0] && e.touches[0].clientX);
                const clientY = e.clientY !== undefined ? e.clientY : (e.touches && e.touches[0] && e.touches[0].clientY);
                if(clientX == null || clientY == null) return;
                let nx = Math.round(startLeft + (clientX - startX));
                let ny = Math.round(startTop + (clientY - startY));
                // constrain to viewport with small padding
                const pad = 8;
                const w = el.offsetWidth || 300;
                const h = el.offsetHeight || 150;
                nx = Math.max(pad, Math.min(window.innerWidth - w - pad, nx));
                ny = Math.max(pad, Math.min(window.innerHeight - h - pad, ny));
                el.style.left = nx + 'px';
                el.style.top = ny + 'px';
            }

            function onPointerUp(e){
                if(!dragging) return;
                dragging = false;
                el.classList.remove('dragging');
                // persist
                try{
                    const l = parseInt(el.style.left||0,10); const t = parseInt(el.style.top||0,10);
                    localStorage.setItem(key, JSON.stringify({ left: l, top: t }));
                }catch(err){ console.warn('save pos failed', err); }
                // cleanup
                document.removeEventListener('pointermove', onPointerMove);
                document.removeEventListener('pointerup', onPointerUp);
                document.removeEventListener('touchmove', onPointerMove);
                document.removeEventListener('touchend', onPointerUp);
                pointerId = null;
            }

            function startDrag(e){
                if(!withinDesktop()) return;
                e.preventDefault && e.preventDefault();
                dragging = true; el.classList.add('dragging');
                startX = e.clientX !== undefined ? e.clientX : (e.touches && e.touches[0] && e.touches[0].clientX);
                startY = e.clientY !== undefined ? e.clientY : (e.touches && e.touches[0] && e.touches[0].clientY);
                startLeft = parseInt(el.style.left||el.getBoundingClientRect().left||0,10);
                startTop = parseInt(el.style.top||el.getBoundingClientRect().top||0,10);
                // capture pointer
                pointerId = e.pointerId || null;
                try{ if(pointerId && e.target && e.target.setPointerCapture) e.target.setPointerCapture(pointerId); }catch(e){}

                document.addEventListener('pointermove', onPointerMove);
                document.addEventListener('pointerup', onPointerUp);
                document.addEventListener('touchmove', onPointerMove, { passive: false });
                document.addEventListener('touchend', onPointerUp);
            }

            // only wire drag handlers when draggable allowed
            if(FLOATING_HISTORY_DRAGGABLE && handle){
                handle.addEventListener('pointerdown', startDrag);
                handle.addEventListener('touchstart', function(e){ e.preventDefault && e.preventDefault(); startDrag(e); }, { passive:false });
            }

            // if not draggable, hide/reset button to avoid confusion
            if(resetBtn){
                if(FLOATING_HISTORY_DRAGGABLE){
                    resetBtn.addEventListener('click', function(){ try{ localStorage.removeItem(key); positionHistory(); applySaved(); }catch(e){ } });
                } else {
                    // visually disable/reset button when history is fixed
                    try{ resetBtn.style.opacity = '0.5'; resetBtn.title = 'Panel fijo ‚Äî reset deshabilitado'; }catch(e){}
                }
            }

            // if resized or scrolled keep position sane
            window.addEventListener('resize', ()=>{ if(!withinDesktop()) return; // keep current pos
                // ensure still inside viewport
                try{ const rect = el.getBoundingClientRect(); const pad=8; const w=el.offsetWidth||300; const h=el.offsetHeight||150; let l = rect.left; let t = rect.top; if(l + w > window.innerWidth - pad) l = Math.max(pad, window.innerWidth - w - pad); if(t + h > window.innerHeight - pad) t = Math.max(pad, window.innerHeight - h - pad); el.style.left = l + 'px'; el.style.top = t + 'px'; }catch(e){}
            });
        })();
    </script>

    <!-- Gesti√≥n: l√≥gica embebida que reemplaza manage-lines.html -->
    <script>
    (function(){
        const STORAGE_KEY = 'pk_lines';
        const listEl = document.getElementById('m-lines-list');
        const btnAdd = document.getElementById('m-btn-add');
        const btnSave = document.getElementById('m-btn-save');
    const btnReset = null;
        const openMain = document.getElementById('open-main');

        function defaultLines(){
            const out = [];
            for(let i=1;i<=10;i++) out.push({ name: 'PK'+i, count: 0 });
            return out;
        }

        function load(){
            try{
                const raw = localStorage.getItem(STORAGE_KEY);
                if(raw){
                    const parsed = JSON.parse(raw);
                    if(Array.isArray(parsed)) return parsed;
                }
                // no stored state: try to infer from current DOM so the manage panel reflects actual parciales
                try{
                    const cols = Array.from(document.querySelectorAll('.container > .column'));
                    if(cols.length > 0){
                        return cols.map(c=>({ name: (c.querySelector('.column-header')||{textContent:''}).textContent.trim(), count: c.querySelectorAll('.block').length }));
                    }
                }catch(e){/* ignore DOM read errors */}
            }catch(e){ console.error(e) }
            return defaultLines();
        }

        function save(lines){
            try{
                localStorage.setItem(STORAGE_KEY, JSON.stringify(lines));
                return true;
            }catch(e){ console.error(e); return false; }
        }

        function render(){
            const lines = load();
            listEl.innerHTML = '';
            lines.forEach((l,idx)=>{
                const row = document.createElement('div'); row.className = 'manage-item';
                const name = document.createElement('input'); name.type='text'; name.value = l.name;
                // mostrar la cantidad como texto (no editable)
                const countSpan = document.createElement('div'); countSpan.style.minWidth = '48px'; countSpan.style.padding = '8px'; countSpan.style.borderRadius = '8px'; countSpan.style.background = 'rgba(0,0,0,0.03)'; countSpan.style.textAlign = 'center'; countSpan.textContent = String(l.count || 0);
                const chkActive = document.createElement('input');
                chkActive.type = 'checkbox';
                chkActive.checked = (l.active !== false);
                chkActive.title = 'L√≠nea activa';
                chkActive.style.width = '18px';
                chkActive.style.height = '18px';
                chkActive.style.cursor = 'pointer';
                const del = document.createElement('button'); del.className='btn btn-del'; del.textContent='Eliminar';
                del.addEventListener('click', ()=>{ lines.splice(idx,1); save(lines); render(); window.dispatchEvent(new StorageEvent('storage',{key:STORAGE_KEY})); });
                // update on change
                name.addEventListener('change', ()=>{ lines[idx].name = name.value.trim() || ('PK'+(idx+1)); save(lines); render(); window.dispatchEvent(new StorageEvent('storage',{key:STORAGE_KEY})); });
                // count is not editable from the manage UI per user request
                chkActive.addEventListener('change', ()=>{
                    lines[idx].active = !!chkActive.checked;
                    save(lines);
                    render();
                    try{ if(window.applyLinesToDOM) window.applyLinesToDOM(lines); }catch(e){}
                    // if deactivating, remove timestamp
                    if(!lines[idx].active){
                        try{
                            const mapRaw = localStorage.getItem('pk_empty_since');
                            const map = mapRaw ? JSON.parse(mapRaw) : {};
                            if(map[lines[idx].name]){ delete map[lines[idx].name]; localStorage.setItem('pk_empty_since', JSON.stringify(map)); }
                        }catch(e){}
                    }
                    window.dispatchEvent(new StorageEvent('storage',{key:STORAGE_KEY}));
                });
                row.appendChild(name); row.appendChild(countSpan); row.appendChild(chkActive); row.appendChild(del);
                listEl.appendChild(row);
            });
        }

        btnAdd && btnAdd.addEventListener('click', ()=>{
            const nameInput = document.getElementById('m-new-name');
            const name = (nameInput.value || '').trim();
            const defaultCount = 0; // fixed default now 0 per user request
            if(!name){ nameInput.focus(); return; }
            if(!confirm(`¬øA√±adir nueva l√≠nea "${name}"?`)) return;
            const lines = load();
            lines.push({ name, count: defaultCount });
            save(lines);
            nameInput.value = '';
            render();
            // notify other tabs via storage event
            window.dispatchEvent(new StorageEvent('storage',{key:STORAGE_KEY}));
        });

        // manejar bot√≥n "Solicitar parcial"
        (function(){
            const solicitar = document.getElementById('btn-solicitar');
            if(!solicitar) return;
            solicitar.addEventListener('click', ()=>{
                const selected = Array.from(document.querySelectorAll('.block.selected-parcial'));
                if(selected.length === 0){
                    try{ status.textContent = 'Selecciona primero uno o m√°s parciales para solicitar.'; }catch(e){}
                    return;
                }
                if(!confirm(`¬øSolicitar ${selected.length} parcial(es)?`)) return;
                // ensure data attributes are present
                try{ ensureBlockDataAttributes(); }catch(e){}

                let added = 0, removed = 0;
                const reqMap = getRequestedMap();
                // load or create solicitud map once
                let solicitudMap = {};
                try{ solicitudMap = JSON.parse(localStorage.getItem('pk_solicitud_salida')||'{}'); }catch(e){ solicitudMap = {}; }

                selected.forEach(s => {
                    try{
                        let lineName = s.getAttribute('data-line') || ((s.closest('.column')||{}).querySelector('.column-header')||{textContent:''}).textContent;
                        lineName = (lineName||'').trim();
                        const idx = parseInt(s.getAttribute('data-index')||'-1',10);
                        const blockText = (s.textContent || s.innerText || '').trim(); // get the order number
                        if(!lineName || !Number.isFinite(idx)){
                            // toggle visual only
                            if(s.classList.contains('requested')){ s.classList.remove('requested'); removed++; }
                            else { s.classList.add('requested'); added++; }
                            s.classList.remove('selected-parcial');
                            return;
                        }

                        // normalize key to avoid whitespace/case mismatches
                        const key = lineName;
                        const arr = Array.isArray(reqMap[key]) ? reqMap[key].slice() : [];
                        const pos = arr.indexOf(idx);
                        if(s.classList.contains('requested') || pos !== -1){
                            // remove request
                            s.classList.remove('requested');
                            if(pos !== -1) arr.splice(pos,1);
                            removed++;
                            // if no more requested for this line, we don't delete solicitud timestamp here (keep for history)
                        } else {
                            // add request
                            s.classList.add('requested');
                            if(pos === -1) arr.push(idx);
                            added++;
                            // set solicitud timestamp for this line (overwrite to now)
                            solicitudMap[key] = solicitudMap[key] || {};
                            solicitudMap[key].solicitud = Date.now();
                            delete solicitudMap[key].salida; // clear salida while new request open
                            try{ console.log('saved solicitud for', key, solicitudMap[key].solicitud); }catch(e){}
                            
                            // NUEVO: Guardar en Firebase
                            try{
                                if(window.FirebaseSync){
                                    window.FirebaseSync.addSolicitud(lineName, blockText).catch(e=>console.warn('Error en solicitud Firebase:', e));
                                }
                            }catch(e){ console.warn('Error agregando solicitud:', e); }
                        }

                        if(arr.length > 0) reqMap[key] = Array.from(new Set(arr)).sort((a,b)=>a-b); else delete reqMap[key];
                        s.classList.remove('selected-parcial');
                    }catch(err){ console.error('solicitar loop error', err); }
                });

                // persist both maps
                try{ saveRequestedMap(reqMap); localStorage.setItem('pk_solicitud_salida', JSON.stringify(solicitudMap)); try{ console.log('saved pk_requested for', Object.keys(reqMap)); }catch(e){} }catch(e){ console.error('failed to save request maps', e); }

                // refresh timers immediately after toggling requests
                try{ ensureTimerElements(); updateColumnTimers(); window.updateSolicitudDurationsDisplay && window.updateSolicitudDurationsDisplay(); }catch(e){ console.error('timer refresh failed', e); }

                // status message
                try{
                    if(added > 0 && removed === 0) status.textContent = `${added} parcial(es) solicitados.`;
                    else if(removed > 0 && added === 0) status.textContent = `${removed} solicitud(es) cancelada(s).`;
                    else status.textContent = `${added} solicitados, ${removed} cancelados.`;
                }catch(e){ }
            });
        })();

        // manejar bot√≥n "Anular solicitud"
        (function(){
            const btnAnular = document.getElementById('btn-anular-solicitud');
            if(!btnAnular) return;
            btnAnular.addEventListener('click', ()=>{
                // Find all requested parcials (those with 'requested' class)
                const requested = Array.from(document.querySelectorAll('.block.requested'));
                if(requested.length === 0){
                    try{ status.textContent = 'No hay solicitudes activas para anular.'; }catch(e){}
                    return;
                }
                
                // Ask for password
                const password = prompt('Ingresa la clave para anular solicitud:', '');
                if(password === null) return; // user cancelled
                
                const correctPassword = localStorage.getItem('pk_admin_password_anular') || 'AB135';
                if(password !== correctPassword){
                    alert('‚ùå Clave incorrecta. La solicitud no ha sido anulada.');
                    return;
                }
                
                // Password correct, proceed with cancellation
                try{ ensureBlockDataAttributes(); }catch(e){}
                
                let canceled = 0;
                const reqMap = getRequestedMap();
                let solicitudMap = {};
                try{ solicitudMap = JSON.parse(localStorage.getItem('pk_solicitud_salida')||'{}'); }catch(e){ solicitudMap = {}; }
                
                requested.forEach(s => {
                    try{
                        let lineName = s.getAttribute('data-line') || ((s.closest('.column')||{}).querySelector('.column-header')||{textContent:''}).textContent;
                        lineName = (lineName||'').trim();
                        const idx = parseInt(s.getAttribute('data-index')||'-1',10);
                        const blockText = (s.textContent || s.innerText || '').trim(); // get the order number
                        if(!lineName || !Number.isFinite(idx)) return;
                        
                        const key = lineName;
                        const arr = Array.isArray(reqMap[key]) ? reqMap[key].slice() : [];
                        const pos = arr.indexOf(idx);
                        
                        // Remove from requested
                        s.classList.remove('requested');
                        if(pos !== -1) arr.splice(pos, 1);
                        canceled++;
                        
                        // Update maps
                        if(arr.length > 0) reqMap[key] = Array.from(new Set(arr)).sort((a,b)=>a-b);
                        else delete reqMap[key];
                        
                        // Clear solicitud timestamp if no more requested items for this line
                        if(arr.length === 0){
                            delete solicitudMap[key];
                        }
                        
                        // NUEVO: Agregar inmediatamente a anulaciones.json
                        try{
                            const now = new Date();
                            const newAnulacion = {
                                linea: lineName,
                                orden_produccion: blockText,
                                fecha_anulacion: now.toLocaleDateString('es-ES'),
                                hora_anulacion: now.toLocaleTimeString('es-ES'),
                                timestamp: now.toISOString()
                            };
                            
                            // Guardar en Firebase
                            try{
                                if(window.FirebaseSync){
                                    window.FirebaseSync.addAnulacion(lineName, blockText).catch(e=>console.warn('Error en anulaci√≥n Firebase:', e));
                                }
                            }catch(e){ console.warn('Error registrando anulaci√≥n:', e); }
                        }catch(e){ console.warn('Error registrando anulaci√≥n:', e); }
                    }catch(err){ console.error('anular loop error', err); }
                });
                
                // Persist changes
                try{ saveRequestedMap(reqMap); localStorage.setItem('pk_solicitud_salida', JSON.stringify(solicitudMap)); }catch(e){ console.error('failed to save anular changes', e); }
                
                // Refresh timers and UI
                try{ ensureTimerElements(); updateColumnTimers(); window.updateSolicitudDurationsDisplay && window.updateSolicitudDurationsDisplay(); }catch(e){ console.error('timer refresh failed', e); }
                
                // Status message
                try{
                    status.style.display = 'block';
                    status.textContent = `‚úÖ ${canceled} solicitud(es) anulada(s) correctamente.`;
                    setTimeout(()=>{ status.textContent = ''; status.style.display = 'none'; }, 3000);
                }catch(e){}
            });
        })();

        // manejar bot√≥n "Abastecer AB" (procesa parciales solicitados y los registra en abastecimientos.json)
        (function(){
            const btnSalida = document.getElementById('btn-salida');
            if(!btnSalida) return;
            btnSalida.addEventListener('click', async ()=>{
                const requested = Array.from(document.querySelectorAll('.block.requested'));
                if(requested.length === 0){
                    try{ status.textContent = 'No hay parciales solicitados para abastecer.'; }catch(e){}
                    return;
                }
                if(!confirm(`¬øAbastecer ${requested.length} parcial(es) en AB?`)) return;

                // procesar cada solicitud: enviar a servidor y remover del DOM
                for(const s of requested){
                    try{
                        try{ ensureBlockDataAttributes(); }catch(e){}
                        let lineName = s.getAttribute('data-line') || ((s.closest('.column')||{}).querySelector('.column-header')||{textContent:''}).textContent;
                        lineName = (lineName||'').trim();
                        const blockText = (s.textContent || s.innerText || '').trim();
                        if(!lineName || !blockText) continue;

                        // enviar al Firebase
                        if(window.FirebaseSync){
                            await window.FirebaseSync.addAbastecimiento(lineName, blockText).catch(e=>console.warn('Error en abastecimiento Firebase:', e));
                        }

                        // visual: eliminar bloque (animaci√≥n)
                        s.classList.remove('requested');
                        s.classList.add('removing');
                        setTimeout(()=>{ try{ s.remove(); }catch(e){} }, 260);
                    }catch(e){ console.error('Error procesando abastecimiento', e); }
                }

                // actualizar estado de kanban en Firebase
                try{
                    const state = (window.DataSync && window.DataSync.getCurrentKanbanState) ? window.DataSync.getCurrentKanbanState() : {};
                    if(window.FirebaseSync){
                        window.FirebaseSync.updateKanbanState(state).catch(()=>{});
                    }
                }catch(e){}

                // refrescar timers y UI
                try{ ensureTimerElements(); updateColumnTimers(); window.updateSolicitudDurationsDisplay && window.updateSolicitudDurationsDisplay(); }catch(e){}
                try{ status.textContent = `‚úÖ ${requested.length} parcial(es) abastecido(s).`; setTimeout(()=>status.textContent='',3000); }catch(e){}
           
            });
        })();

        btnSave && btnSave.addEventListener('click', ()=>{
            if(!confirm('¬øGuardar cambios en la gesti√≥n de l√≠neas?')) return;
            const lines = load();
            const ok = save(lines);
            if(ok){
                // apply immediately to main UI in same tab
                try{ if(window.applyLinesToDOM) window.applyLinesToDOM(lines); }catch(e){}
                alert('‚úÖ Cambios guardados.');
            } else alert('‚ùå Error al guardar.');
        });

        // reset button removed per user request

        // initial
        render();
    })();

    // Ocultar completamente el elemento top-info
    (function(){
        const topInfo = document.getElementById('top-info');
        if(topInfo) {
            topInfo.style.display = 'none !important';
            topInfo.style.visibility = 'hidden';
            topInfo.style.position = 'absolute';
            topInfo.style.left = '-9999px';
            topInfo.style.top = '-9999px';
        }
    })();
    </script>

    <!-- Sistema de almacenamiento JSON sin servidor (solo localStorage + descarga manual) -->
    <script>
    (function(){
        // Sistema completo de sincronizaci√≥n sin necesidad de servidor Node.js
        const DataSync = {
            // Obtener estado actual del kanban desde el DOM
            getCurrentKanbanState() {
                const state = {};
                const cols = document.querySelectorAll('.container .column');
                cols.forEach(col => {
                    const header = (col.querySelector('.column-header')||{textContent:''}).textContent.trim();
                    if(header){
                        const blocks = [];
                        col.querySelectorAll('.block').forEach(b => {
                            const blockText = (b.textContent || b.innerText || '').trim();
                            blocks.push(blockText);
                        });
                        state[header] = blocks;
                    }
                });
                return state;
            },

            // Obtener solicitudes desde historial
            getCurrentSolicitudes() {
                const solicitudes = [];
                let history = [];
                try { history = JSON.parse(localStorage.getItem('pk_history')||'[]'); } catch(e){}
                
                const solicitudMap = {};
                history.forEach(entry => {
                    if(entry && entry.line && entry.requestedAt){
                        if(!solicitudMap[entry.name]){
                            solicitudMap[entry.name] = {
                                linea: entry.line,
                                nombre: entry.name,
                                requestedAt: entry.requestedAt
                            };
                        }
                    }
                });
                
                Object.values(solicitudMap).forEach(item => {
                    if(item.requestedAt){
                        const date = new Date(parseInt(item.requestedAt, 10));
                        solicitudes.push({
                            linea: item.linea,
                            orden_produccion: item.nombre,
                            fecha_solicitud: date.toLocaleDateString('es-ES'),
                            hora_solicitud: date.toLocaleTimeString('es-ES'),
                            timestamp: date.toISOString()
                        });
                    }
                });
                return solicitudes;
            },

            // Obtener abastecimientos desde historial
            getCurrentAbastecimientos() {
                const abastecimientos = [];
                let history = [];
                try { history = JSON.parse(localStorage.getItem('pk_history')||'[]'); } catch(e){}
                
                history.forEach(entry => {
                    if(entry && entry.suppliedAt && entry.line && entry.name){
                        const date = new Date(parseInt(entry.suppliedAt, 10));
                        abastecimientos.push({
                            linea: entry.line,
                            orden_produccion: entry.name,
                            fecha_abastecimiento: date.toLocaleDateString('es-ES'),
                            hora_abastecimiento: date.toLocaleTimeString('es-ES'),
                            timestamp: date.toISOString()
                        });
                    }
                });
                return abastecimientos;
            },

            // Guardar datos en localStorage + Firebase (sincronizaci√≥n autom√°tica)
            syncAll() {
                try {
                    const kanban = this.getCurrentKanbanState();
                    const solicitudes = this.getCurrentSolicitudes();
                    const abastecimientos = this.getCurrentAbastecimientos();
                    const anulaciones = [];
                    
                    console.log('üì§ Enviando a Firebase - Kanban:', kanban, 'Solicitudes:', solicitudes);
                    
                    // Guardar en localStorage
                    localStorage.setItem('json_kanban_state', JSON.stringify(kanban, null, 2));
                    localStorage.setItem('json_solicitudes', JSON.stringify(solicitudes, null, 2));
                    localStorage.setItem('json_abastecimientos', JSON.stringify(abastecimientos, null, 2));
                    localStorage.setItem('json_anulaciones', JSON.stringify(anulaciones, null, 2));
                    
                    // Guardar en Firebase AHORA (sin esperar callbacks)
                    if(window.db){
                        window.db.ref('kanban_estado').set(kanban, (error) => {
                            if(error) {
                                console.error('‚ùå Error guardando kanban en Firebase:', error);
                            } else {
                                console.log('‚úÖ Kanban guardado en Firebase:', kanban);
                            }
                        });
                        
                        window.db.ref('solicitudes').set(solicitudes, (error) => {
                            if(error) {
                                console.error('‚ùå Error guardando solicitudes en Firebase:', error);
                            } else {
                                console.log('‚úÖ Solicitudes guardadas en Firebase');
                            }
                        });
                        
                        window.db.ref('abastecimientos').set(abastecimientos, (error) => {
                            if(error) {
                                console.error('‚ùå Error guardando abastecimientos en Firebase:', error);
                            } else {
                                console.log('‚úÖ Abastecimientos guardados en Firebase');
                            }
                        });
                    } else {
                        console.warn('‚ö† Firebase no disponible. Solo localStorage.');
                    }
                    
                    console.log('‚úÖ Datos sincronizados en localStorage y Firebase');
                } catch(e) {
                    console.error('‚ùå Error sincronizando:', e);
                }
            },

            // Descargar un JSON como archivo
            downloadJSON(key, filename) {
                try {
                    const data = localStorage.getItem(key);
                    if(!data){
                        alert(`‚ùå No hay datos para: ${filename}`);
                        return;
                    }
                    const blob = new Blob([data], { type: 'application/json; charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    console.log(`‚úÖ Descargando: ${filename}`);
                } catch(e) {
                    console.error('‚ùå Error descargando:', e);
                }
            },

            // Descargar todos los JSONs
            downloadAllJSONs() {
                console.log('üì• Iniciando descarga de archivos JSON...');
                this.downloadJSON('json_kanban_state', 'kanban_estado.json');
                setTimeout(()=>this.downloadJSON('json_solicitudes', 'solicitudes.json'), 300);
                setTimeout(()=>this.downloadJSON('json_abastecimientos', 'abastecimientos.json'), 600);
                setTimeout(()=>this.downloadJSON('json_anulaciones', 'anulaciones.json'), 900);
            }
        };

        // Exponer globalmente
        window.DataSync = DataSync;

        // Sincronizar cada 5 segundos a Firebase (no localStorage)
        try{
            // Send data to Firebase every 5 seconds for automatic syncing
            const sendToFirebase = () => {
                try{
                    // Enviar s√≥lo el estado del kanban a Firebase cada 5s
                    try{
                        const state = DataSync.getCurrentKanbanState();
                        if(window.FirebaseSync){
                            window.FirebaseSync.updateKanbanState(state).catch(()=>{});
                        }
                    }catch(e){ console.warn('Error enviando kanban state a Firebase', e); }
                }catch(e){ console.warn('Error sending to Firebase:', e); }
            };

            // Sincronizar a Firebase cada 5 segundos (no localStorage)
            setInterval(() => {
                sendToFirebase();
            }, 5000);

            // debounced sync for rapid DOM changes
            let _syncDebounceTimer = null;
            const scheduleDebouncedSync = (ms = 700) => {
                clearTimeout(_syncDebounceTimer);
                _syncDebounceTimer = setTimeout(()=>{
                    // Envia cambios r√°pidos a Firebase
                    sendToFirebase();
                }, ms);
            };

            // Observe DOM changes under the main container to trigger sync
            const container = document.querySelector('.container') || document.body;
            try{
                const observer = new MutationObserver(mutations => {
                    // if there are many mutations, debounce into a single sync
                    scheduleDebouncedSync(700);
                });
                observer.observe(container, { childList: true, subtree: true, attributes: true, characterData: true });
            }catch(e){ console.warn('MutationObserver not available', e); }

            // Also listen to clicks that likely change state (safety net)
            document.addEventListener('click', (ev)=>{
                const t = ev.target;
                if(t && (t.closest && (t.closest('.block') || t.matches('button') || t.matches('input') || t.matches('select')))){
                    scheduleDebouncedSync(800);
                    // Fire and forget to Firebase
                    try { sendToFirebase(); } catch(e) {}
                }
            }, {capture:true});

            // Ensure final sync to Firebase before unload
            window.addEventListener('beforeunload', () => {
                try { sendToFirebase(); } catch(e) {}
            });

            console.log('‚úÖ Sistema de sincronizaci√≥n con Firebase listo');
            console.log('üìç Los datos se guardan en Firebase Realtime Database autom√°ticamente cada 5 segundos');
            console.log('üî• Monitorea en tiempo real en: https://console.firebase.google.com');
        }catch(e){ console.error('Error configuring autosync', e); }
    })();
    </script>

    <!-- Limpieza segura al iniciar: elimina bloques est√°ticos si no hay datos persistentes -->
    <script>
    (function(){
        try{
            const requiredKeys = ['json_kanban_state','pk_lines','pk_history'];
            const hasData = requiredKeys.some(k=>{
                const v = localStorage.getItem(k);
                if(!v) return false;
                try{
                    const s = v.toString().trim();
                    if(s === '' || s === '{}' || s === '[]') return false;
                }catch(e){ }
                return true;
            });

            if(!hasData){
                const blocks = document.querySelectorAll('.block');
                if(blocks.length > 0){
                    console.warn('Startup cleanup: removing', blocks.length, 'static .block elements because no persisted data found.');
                    blocks.forEach(b=>b.remove());
                    try{ if(window.applyLinesToDOM) window.applyLinesToDOM([]); }catch(e){}

                    // Tambi√©n eliminar claves residuales que pueden causar repoblado
                    ['pk_lines','pk_block_names','pk_requested','pk_solicitud_salida','pk_empty_since','json_kanban_state','json_solicitudes','json_abastecimientos','json_anulaciones'].forEach(k=>localStorage.removeItem(k));
                    console.log('Startup cleanup completed.');
                }
            }
        }catch(e){ console.error('Startup cleanup failed', e); }
    })();
    </script>
        <!-- Panel de Control Interno (oculto por defecto) -->
        <div id="panel-control-interno" style="display:none; position:fixed; inset:0; background:#ffffff; z-index:9999;">
            <style id="panel-styles">
                #panel-control-interno { font-family: Inter, system-ui, Arial, sans-serif; }
                #panel-control-interno .panel-shell { width:100%; height:100vh; margin:0; background: linear-gradient(180deg,#fbfdff,#ffffff); border-radius:0; padding:28px 32px; box-shadow:none; position:relative; display:flex; flex-direction:column; }
                #panel-control-interno h2 { font-size:28px; color:#4b2991; margin:6px 0 18px 0; font-weight:800; }
                #panel-control-interno .panel-actions { display:flex; gap:14px; justify-content:center; margin:8px 0 18px 0; flex-wrap:wrap; }
                #panel-control-interno .panel-actions button { padding:12px 20px; font-size:16px; border-radius:10px; box-shadow:0 8px 20px rgba(12,20,30,0.06); border:0; color:white; font-weight:700; cursor:pointer; transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease; }
                #panel-control-interno .panel-actions button:hover { transform: translateY(-3px); box-shadow:0 18px 36px rgba(12,20,30,0.12); }
                #btn-cerrar-panel { position:absolute; left:14px; top:14px; background:#fff; border:1px solid #e6e6e9; padding:8px 12px; border-radius:8px; color:#333; }
                #panel-export-excel { background:linear-gradient(90deg,#f59e0b,#f97316); }
                #panel-sync-firebase { background:linear-gradient(90deg,#3b82f6,#0ea5e9); }
                #panel-refresh-db { background:#6b7280; }
                #panel-reset-firebase { background:#ef4444; }
                #panel-change-pass { background:#10b981; }
                #panel-control-interno .change-pass-row { display:flex; gap:10px; align-items:center; justify-content:center; margin-bottom:12px; }
                #panel-control-interno input#panel-new-pass { padding:10px; border-radius:8px; border:1px solid #e5e7eb; font-size:15px; min-width:180px; }
                #panel-control-interno #panel-content { margin-top:10px; flex:1; overflow:auto; }
                #panel-control-interno #panel-historial-list { max-height:680px; overflow:auto; background:linear-gradient(180deg,#ffffff,#fbfbff); padding:14px; border-radius:10px; border:1px solid #f0f0f5; }
                #panel-control-interno #panel-historial-list .hist-item { padding:12px; border-bottom:1px solid #f3f3f6; font-size:15px; }
                #panel-control-interno #panel-historial-list .hist-item strong { font-size:16px; color:#111827; }
            </style>
            <div class="panel-shell">
                <button id="btn-cerrar-panel">Volver</button>
                <h2 style="text-align:center;">Panel de Control</h2>
                <div class="panel-actions">
                    <button id="panel-export-excel">Exportar Excel</button>
                    <button id="panel-sync-firebase">üîÑ Sincronizar desde Firebase</button>
                    <button id="panel-refresh-db">Refrescar Datos</button>
                    <button id="panel-reset-firebase">Reiniciar Firebase</button>
                </div>
                <div class="change-pass-row">
                    <label for="panel-new-pass" style="font-weight:700;">Cambiar clave Anular:</label>
                    <input id="panel-new-pass" type="password" placeholder="Nueva clave" />
                    <button id="panel-change-pass">Cambiar</button>
                </div>
                <div id="panel-content">
                    <h3 style="margin-left:8px;">Historial (√∫ltimos 20)</h3>
                    <div id="panel-historial-list"></div>
                </div>
            </div>
        </div>
    </body>
<!-- Removed duplicate closing html tag -->
    <!-- SheetJS Library for Excel generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
    // Funciones utilitarias para exportar datos - UN √öNICO EXCEL con 5 pesta√±as
    async function exportAllData(){
        try{
            if(!window.XLSX){
                alert('‚ùå Librer√≠a XLSX no cargada. Intenta de nuevo en 2 segundos.');
                return;
            }
            
            const result = {};
            const paths = ['solicitudes','abastecimientos','anulaciones','historial','kanban_estado'];
            
            // Cargar datos desde localStorage o Firebase
            if(window.db){
                for(const p of paths){
                    try{
                        const snap = await window.db.ref(p).once('value');
                        result[p] = snap.val() || {};
                    }catch(e){ console.warn('Error leyendo',p,e); result[p] = {}; }
                }
            } else {
                try{ result.solicitudes = JSON.parse(localStorage.getItem('json_solicitudes')||'{}'); }catch(e){ result.solicitudes = {}; }
                try{ result.abastecimientos = JSON.parse(localStorage.getItem('json_abastecimientos')||'{}'); }catch(e){ result.abastecimientos = {}; }
                try{ result.anulaciones = JSON.parse(localStorage.getItem('json_anulaciones')||'{}'); }catch(e){ result.anulaciones = {}; }
                try{ result.historial = (window.historialModule && window.historialModule.obtenerHistorial && window.historialModule.obtenerHistorial()) || {}; }catch(e){ result.historial = {}; }
                try{ result.kanban_estado = JSON.parse(localStorage.getItem('json_kanban_state')||'{}'); }catch(e){ result.kanban_estado = {}; }
            }

            // Crear workbook Excel con 5 hojas
            const wb = XLSX.utils.book_new();
            
            // HOJA 1: Solicitudes
            const solicitudes = result.solicitudes || {};
            const solArray = Array.isArray(solicitudes) ? solicitudes : Object.entries(solicitudes).map(([id,v])=>({id,...v}));
            if(solArray.length > 0){
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(solArray.map(s=>({
                    'L√≠nea': s.linea || s.line || '',
                    'Orden Producci√≥n': s.orden_produccion || s.orderNumber || '',
                    'Fecha Solicitud': s.fecha_solicitud || s.requestedAt || '',
                    'Hora Solicitud': s.hora_solicitud || '',
                    'Timestamp': s.timestamp || ''
                }))), 'Solicitudes');
            }
            
            // HOJA 2: Abastecimientos
            const abastecimientos = result.abastecimientos || {};
            const abastArray = Array.isArray(abastecimientos) ? abastecimientos : Object.entries(abastecimientos).map(([id,v])=>({id,...v}));
            if(abastArray.length > 0){
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(abastArray.map(a=>({
                    'L√≠nea': a.linea || a.line || '',
                    'Orden Producci√≥n': a.orden_produccion || a.orderNumber || '',
                    'Fecha Abastecimiento': a.fecha_abastecimiento || a.suppliedAt || '',
                    'Hora Abastecimiento': a.hora_abastecimiento || '',
                    'Timestamp': a.timestamp || ''
                }))), 'Abastecimientos');
            }
            
            // HOJA 3: Anulaciones
            const anulaciones = result.anulaciones || {};
            const anulArray = Array.isArray(anulaciones) ? anulaciones : Object.entries(anulaciones).map(([id,v])=>({id,...v}));
            if(anulArray.length > 0){
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(anulArray.map(an=>({
                    'L√≠nea': an.linea || an.line || '',
                    'Orden Producci√≥n': an.orden_produccion || an.orderNumber || '',
                    'Fecha Anulaci√≥n': an.fecha_anulacion || '',
                    'Hora Anulaci√≥n': an.hora_anulacion || '',
                    'Timestamp': an.timestamp || ''
                }))), 'Anulaciones');
            }
            
            // HOJA 4: Historial
            const historial = result.historial || {};
            const histArray = Array.isArray(historial) ? historial : Object.entries(historial).map(([id,v])=>({id,...v}));
            if(histArray.length > 0){
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(histArray.map(h=>({
                    'Nombre': h.name || h.nombre || '',
                    'L√≠nea': h.line || h.linea || '',
                    '√çndice': h.index || h.idx || '',
                    'Solicitado': h.requestedAt || h.fecha_solicitud || '',
                    'Abastecido': h.suppliedAt || h.fecha_abastecimiento || '',
                    'Duraci√≥n': h.duration || h.duracion || ''
                }))), 'Historial');
            }
            
            // HOJA 5: Estado Kanban
            const kanban = result.kanban_estado || {};
            const kanbanArray = Array.isArray(kanban) ? kanban : Object.entries(kanban).map(([nombre_linea,v])=>({
                'L√≠nea': nombre_linea,
                '√ìrdenes': Array.isArray(v?.ordenes) ? v.ordenes.join(', ') : (v?.ordenes || '')
            }));
            if(kanbanArray.length > 0){
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(kanbanArray), 'Kanban');
            }
            
            // Descargar archivo
            const fecha = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `estado-vidrio-${fecha}.xlsx`);
            alert('‚úÖ Excel con 5 pesta√±as descargado correctamente.');
        }catch(e){ 
            console.error('exportAllData error', e); 
            alert('‚ùå Error exportando datos:\n' + (e.message || String(e))); 
        }
    }

    function downloadBlob(filename, blob){
        try{
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(()=>URL.revokeObjectURL(url), 2000);
        }catch(e){ console.error('downloadBlob error', e); }
    }

    function objArrayToCSV(arr){
        const headerSet = new Set();
        arr.forEach(o=>{ Object.keys(o||{}).forEach(k=>headerSet.add(k)); });
        const headers = Array.from(headerSet);
        const lines = [headers.join(',')];
        for(const o of arr){
            const row = headers.map(h=>{
                let v = o[h] !== undefined ? o[h] : '';
                if(v === null) v = '';
                v = String(v).replace(/"/g, '""');
                if(v.indexOf(',')!==-1 || v.indexOf('\n')!==-1) v = '"'+v+'"';
                return v;
            }).join(',');
            lines.push(row);
        }
        return lines.join('\n');
    }

    // Panel interno: l√≥gica de render y botones
    function renderPanelContent(){
        // render historial from Firebase (abastecimientos/historial)
        const listEl = document.getElementById('panel-historial-list');
        if(!listEl) return;
        listEl.innerHTML = '<em>Cargando...</em>';
        // try realtime DB first
        try{
            if(window.FirebaseSync && window.db){
                window.db.ref('historial').limitToLast(20).orderByKey().once('value', snap=>{
                    const data = snap.val() || {};
                    const keys = Object.keys(data).sort().reverse();
                    if(keys.length === 0){ listEl.innerHTML = '<em>No hay registros.</em>'; return; }
                    listEl.innerHTML = keys.map(k=>{
                        const it = data[k];
                        return `<div class="hist-item"><strong>${it.name||it.parcial||'‚Äî'}</strong><div style="font-size:12px;color:#666">Linea: ${it.line||it.pk||'‚Äî'} ‚Äî ${it.fecha||''} ${it.hora||''}</div></div>`;
                    }).join('');
                });
            } else {
                // fallback: try historialModule if present
                if(window.historialModule && window.historialModule.obtenerHistorial){
                    const arr = window.historialModule.obtenerHistorial() || [];
                    if(arr.length === 0) { listEl.innerHTML = '<em>No hay registros.</em>'; return; }
                    listEl.innerHTML = arr.slice(0,20).map(it=>`<div class="hist-item"><strong>${it.name||it.parcial||'‚Äî'}</strong><div style="font-size:12px;color:#666">Linea: ${it.line||it.pk||'‚Äî'} ‚Äî ${it.fecha_solicitud||it.fecha||''} ${it.hora_solicitud||it.hora||''}</div></div>`).join('');
                } else {
                    listEl.innerHTML = '<em>Historial no disponible.</em>';
                }
            }
        }catch(e){ listEl.innerHTML = '<em>Error cargando historial.</em>'; console.error(e); }
    }

    // ==========================================
    // CARGAR DATOS SOLO DESDE FIREBASE (Firebase como fuente √∫nica de verdad)
    // ==========================================
    async function loadAllDataFromFirebase(){
        try{
            let kanbanData = {};
            let solicitudesData = {};
            let abastecimientosData = {};
            let anulacionesData = {};
            let historialData = {};

            // Si Firebase est√° disponible, cargar desde ah√≠
            if(window.db){
                console.log('üì• Descargando TODOS los datos desde Firebase...');

                // Usar Promises para cargar en paralelo
                await Promise.all([
                    new Promise(resolve => {
                        window.db.ref('kanban_estado').once('value', (snap) => {
                            kanbanData = snap.val() || {};
                            console.log('‚úÖ Kanban desde Firebase:', kanbanData);
                            resolve();
                        });
                    }),
                    new Promise(resolve => {
                        window.db.ref('solicitudes').once('value', (snap) => {
                            solicitudesData = snap.val() || {};
                            console.log('‚úÖ Solicitudes desde Firebase:', solicitudesData);
                            resolve();
                        });
                    }),
                    new Promise(resolve => {
                        window.db.ref('abastecimientos').once('value', (snap) => {
                            abastecimientosData = snap.val() || {};
                            console.log('‚úÖ Abastecimientos desde Firebase:', abastecimientosData);
                            resolve();
                        });
                    }),
                    new Promise(resolve => {
                        window.db.ref('anulaciones').once('value', (snap) => {
                            anulacionesData = snap.val() || {};
                            console.log('‚úÖ Anulaciones desde Firebase:', anulacionesData);
                            resolve();
                        });
                    }),
                    new Promise(resolve => {
                        window.db.ref('historial').once('value', (snap) => {
                            historialData = snap.val() || {};
                            console.log('‚úÖ Historial desde Firebase:', historialData);
                            resolve();
                        });
                    })
                ]);
            } else {
                console.warn('‚ö† Firebase no disponible. Intentando cargar desde localStorage/fallback...');
                // Fallback: cargar desde localStorage si existen datos previos
                try {
                    kanbanData = JSON.parse(localStorage.getItem('json_kanban_state') || '{}');
                    solicitudesData = JSON.parse(localStorage.getItem('json_solicitudes') || '{}');
                    abastecimientosData = JSON.parse(localStorage.getItem('json_abastecimientos') || '{}');
                    anulacionesData = JSON.parse(localStorage.getItem('json_anulaciones') || '{}');
                    historialData = JSON.parse(localStorage.getItem('json_historial') || '{}');
                    console.log('‚úÖ Datos cargados desde localStorage');
                } catch (e) {
                    console.warn('‚ö† No hay datos en localStorage');
                }
            }

            // Guardar en localStorage (como cach√©)
            localStorage.setItem('json_kanban_state', JSON.stringify(kanbanData, null, 2));
            localStorage.setItem('json_solicitudes', JSON.stringify(solicitudesData, null, 2));
            localStorage.setItem('json_abastecimientos', JSON.stringify(abastecimientosData, null, 2));
            localStorage.setItem('json_anulaciones', JSON.stringify(anulacionesData, null, 2));
            localStorage.setItem('json_historial', JSON.stringify(historialData, null, 2));

            console.log('‚úÖ Todos los datos cargados correctamente');

            // Convertir kanbanData a array de l√≠neas para renderizar
            const lines = Object.keys(kanbanData).map(lineName => ({
                name: lineName,
                count: (kanbanData[lineName] || []).length,
                active: true
            }));

            // Si no hay l√≠neas en Firebase, usar las l√≠neas por defecto
            if(lines.length === 0){
                const defaultLines = ['PKB1', 'PKB2', 'PKB3', 'PKB4', 'PKB5', 'PKB6', 'JVH2', 'EYS', 'MAQ'];
                lines.push(...defaultLines.map(name => ({ name, count: 0, active: true })));
                console.log('üìã Usando l√≠neas por defecto:', lines);
            }

            // Guardar l√≠neas en localStorage y renderizar
            localStorage.setItem('pk_lines', JSON.stringify(lines));
            
            // Aplicar l√≠neas al DOM
            if(window.applyLinesToDOM){
                window.applyLinesToDOM(lines);
                console.log('üé® L√≠neas aplicadas al DOM');
            }

            return true;
        }catch(e){
            console.error('‚ùå Error cargando datos:', e);
            return false;
        }
    }

    // ==========================================
    // ESCUCHAR CAMBIOS EN TIEMPO REAL (Listeners activos)
    // ==========================================
    async function initFirebaseSync(){
        try{
            if(window.firebaseInitPromise){
                await window.firebaseInitPromise;
            }
            
            if(!window.db){
                console.warn('‚ö† Firebase DB no disponible.');
                return;
            }

            console.log('üîä Iniciando listeners de Firebase en tiempo real...');

            // Escuchar cambios en kanban_estado
            window.db.ref('kanban_estado').on('value', (snap) => {
                const firebaseKanban = snap.val() || {};
                localStorage.setItem('json_kanban_state', JSON.stringify(firebaseKanban, null, 2));
                console.log('üîÑ Kanban actualizado desde Firebase en tiempo real:', firebaseKanban);
                
                // Obtener l√≠neas actuales del DOM (fijas)
                const currentLines = JSON.parse(localStorage.getItem('pk_lines') || '[]');
                
                // Actualizar SOLO los conteos de parciales, mantener los t√≠tulos fijos
                const updatedLines = currentLines.map(line => ({
                    name: line.name,
                    count: (firebaseKanban[line.name] || []).length,
                    active: line.active !== false
                }));
                
                localStorage.setItem('pk_lines', JSON.stringify(updatedLines));
                
                // Actualizar pk_block_names para reflejar los nombres de parciales
                const pk_block_names = {};
                Object.keys(firebaseKanban).forEach(lineName => {
                    const blocks = firebaseKanban[lineName] || [];
                    pk_block_names[lineName] = {};
                    blocks.forEach((blockName, idx) => {
                        if(blockName){
                            pk_block_names[lineName][String(idx)] = blockName;
                        }
                    });
                });
                localStorage.setItem('pk_block_names', JSON.stringify(pk_block_names));
                
                // Refrescar bloques sin cambiar estructura de columnas
                if(window.applyLinesToDOM){
                    try{
                        window.applyLinesToDOM(updatedLines);
                        console.log('üì¶ Parciales actualizados en tiempo real');
                    }catch(e){
                        console.error('Error actualizando parciales:', e);
                    }
                }
            });

            // Escuchar cambios en solicitudes
            window.db.ref('solicitudes').on('value', (snap) => {
                const firebaseSolicitudes = snap.val() || {};
                localStorage.setItem('json_solicitudes', JSON.stringify(firebaseSolicitudes, null, 2));
                
                // Convertir solicitudes de Firebase a pk_requested y pk_solicitud_salida
                const pk_requested = {};
                const pk_solicitud_salida = {};
                
                Object.keys(firebaseSolicitudes).forEach(lineName => {
                    const lineData = firebaseSolicitudes[lineName];
                    if(lineData && typeof lineData === 'object'){
                        pk_requested[lineName] = Object.keys(lineData).filter(key => {
                            const val = lineData[key];
                            return val && val.requestedAt;
                        }).map(key => parseInt(key));
                        
                        pk_solicitud_salida[lineName] = {};
                        Object.keys(lineData).forEach(key => {
                            if(lineData[key] && lineData[key].requestedAt){
                                pk_solicitud_salida[lineName][key] = lineData[key].requestedAt;
                            }
                        });
                    }
                });
                
                localStorage.setItem('pk_requested', JSON.stringify(pk_requested));
                localStorage.setItem('pk_solicitud_salida', JSON.stringify(pk_solicitud_salida));
                
                // Actualizar UI
                if(window.applyRequestedToDOM){
                    try{
                        window.applyRequestedToDOM();
                        console.log('üìç Solicitudes actualizadas en tiempo real');
                    }catch(e){
                        console.warn('Error aplicando solicitudes:', e);
                    }
                }
                
                console.log('üîÑ Solicitudes sincronizadas desde Firebase');
            });

            // Escuchar cambios en abastecimientos
            window.db.ref('abastecimientos').on('value', (snap) => {
                const firebaseAbastecimientos = snap.val() || {};
                localStorage.setItem('json_abastecimientos', JSON.stringify(firebaseAbastecimientos, null, 2));
                
                // Convertir abastecimientos a pk_history
                const pk_history = [];
                Object.keys(firebaseAbastecimientos).forEach(lineName => {
                    const lineData = firebaseAbastecimientos[lineName];
                    if(lineData && typeof lineData === 'object'){
                        Object.keys(lineData).forEach(key => {
                            const entry = lineData[key];
                            if(entry){
                                pk_history.push({
                                    lineName: lineName,
                                    parcial: entry.parcial || entry.name || 'N/A',
                                    timestamp: entry.timestamp || entry.suppliedAt || Date.now(),
                                    fecha: entry.fecha || new Date().toLocaleDateString(),
                                    hora: entry.hora || new Date().toLocaleTimeString()
                                });
                            }
                        });
                    }
                });
                
                localStorage.setItem('pk_history', JSON.stringify(pk_history.slice(-200)));
                
                // Actualizar historial en la UI
                try{
                    if(window.historialModule && window.historialModule.renderizar){
                        window.historialModule.renderizar();
                        console.log('üìã Historial actualizado en tiempo real');
                    }
                }catch(e){
                    console.warn('Error actualizando historial:', e);
                }
                
                console.log('üîÑ Abastecimientos sincronizados desde Firebase');
            });

            // Escuchar cambios en anulaciones
            window.db.ref('anulaciones').on('value', (snap) => {
                const firebaseAnulaciones = snap.val() || {};
                localStorage.setItem('json_anulaciones', JSON.stringify(firebaseAnulaciones, null, 2));
                console.log('üîÑ Anulaciones actualizadas desde Firebase en tiempo real');
            });
            
            console.log('‚úÖ Listeners de Firebase inicializados correctamente');
        }catch(e){
            console.warn('‚ö† Error inicializando Firebase listeners:', e.message);
        }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
        const panel = document.getElementById('panel-control-interno');
        const btnCerrar = document.getElementById('btn-cerrar-panel');
        const btnExport = document.getElementById('panel-export-excel');
        const btnSync = document.getElementById('panel-sync-firebase');
        const btnRefresh = document.getElementById('panel-refresh-db');
        const btnReset = document.getElementById('panel-reset-firebase');
        const btnChangePass = document.getElementById('panel-change-pass');
        const inputNewPass = document.getElementById('panel-new-pass');
        if(btnCerrar) btnCerrar.addEventListener('click', ()=>{ panel.style.display='none'; document.body.style.overflow=''; try{ window.scrollTo(0,0); }catch(e){} });
        if(btnExport){ btnExport.addEventListener('click', async ()=>{ try{ await exportAllData(); }catch(e){ console.warn('export button fallback', e); if(window.historialModule && window.historialModule.exportar) window.historialModule.exportar(); else alert('Funci√≥n exportar no disponible.'); } }); }
        if(btnSync){ btnSync.addEventListener('click', async ()=>{ 
            try{ 
                btnSync.disabled = true; 
                btnSync.textContent = '‚è≥ Sincronizando desde Firebase...';
                const success = await loadAllDataFromFirebase(); 
                if(success){
                    alert('‚úÖ P√°gina recargada con datos de Firebase.');
                } else {
                    alert('‚ö† Error sincronizando. Revisa la consola.');
                }
                btnSync.textContent = 'üîÑ Sincronizar desde Firebase';
                btnSync.disabled = false;
            }catch(e){ 
                console.error('Error sincronizando:', e);
                alert('‚ùå Error sincronizando: ' + (e.message || String(e)));
                btnSync.textContent = 'üîÑ Sincronizar desde Firebase';
                btnSync.disabled = false;
            } 
        }); }
        if(btnRefresh){ btnRefresh.addEventListener('click', ()=>{ renderPanelContent(); }); }
        if(btnReset){ btnReset.addEventListener('click', async ()=>{
            try{
                // Preguntar si desea exportar antes
                const wantExport = confirm('¬øDeseas exportar los datos antes de reiniciar? Aceptar=Exportar ahora, Cancelar=No y continuar.');
                if(wantExport){ await exportAllData(); }
                else { const cont = confirm('¬øDeseas continuar sin exportar? Aceptar=Continuar, Cancelar=Cancelar reinicio'); if(!cont){ alert('Reinicio cancelado.'); return; } }

                const confirmText = prompt("Escribe 'RESET' para confirmar el reinicio de datos:", '');
                if(confirmText !== 'RESET'){ alert('Reinicio cancelado.'); return; }
                const adminPass = prompt('Ingresa la clave admin para confirmar reinicio:', '');
                const stored = localStorage.getItem('pk_admin_password_anular') || 'AB135';
                if(adminPass !== stored){ alert('Clave admin incorrecta. Reinicio cancelado.'); return; }
                if(!window.db){ alert('Firebase no est√° disponible. No se pudo reiniciar.'); return; }
                const paths = ['historial','abastecimientos','solicitudes','anulaciones'];
                for(const p of paths){
                    try{ await window.db.ref(p).remove(); }catch(e){ console.warn('Error borrando',p,e); }
                }
                // limpiar tambi√©n claves locales relacionadas
                ['pk_solicitud_salida','pk_requested','json_kanban_state','json_solicitudes','json_abastecimientos','json_anulaciones','pk_lines','pk_block_names'].forEach(k=>localStorage.removeItem(k));
                alert('‚úÖ Reinicio de Firebase completado.');
                renderPanelContent();
            }catch(e){ console.error('reset error', e); alert('Error durante reinicio. Revisa la consola.'); }
        }); }
        if(btnChangePass){ btnChangePass.addEventListener('click', ()=>{
            try{
                const newPass = (inputNewPass && inputNewPass.value || '').trim();
                if(!newPass){ alert('Ingrese una nueva clave v√°lida.'); return; }
                const current = prompt('Ingresa la clave actual para confirmar cambio:', '');
                const stored = localStorage.getItem('pk_admin_password_anular') || 'AB135';
                if(current !== stored){ alert('Clave actual incorrecta. Cambio cancelado.'); return; }
                localStorage.setItem('pk_admin_password_anular', newPass);
                inputNewPass.value = '';
                alert('‚úÖ Clave para anular solicitudes actualizada.');
            }catch(e){ console.error('change pass error', e); alert('Error cambiando clave.'); }
        }); }
        
        // ===== FUNCIONALIDAD DE BARRA DE NAVEGACI√ìN M√ìVIL =====
        if(window.innerWidth <= 768){
            const navButtons = document.querySelectorAll('#mobile-bottom-nav button');
            const mobilePanel = document.getElementById('panel-control-interno');
            
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.getAttribute('data-tab');
                    
                    // Actualizar bot√≥n activo
                    navButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Ejecutar acci√≥n seg√∫n tab
                    switch(tab){
                        case 'kanban':
                            // Volver a kanban (cerrar panel)
                            if(mobilePanel) mobilePanel.style.display = 'none';
                            document.body.style.overflow = '';
                            window.scrollTo(0, 0);
                            break;
                        case 'panel':
                            // Abrir panel de control
                            if(mobilePanel) mobilePanel.style.display = 'block';
                            document.body.style.overflow = 'hidden';
                            break;
                        case 'export':
                            // Exportar Excel
                            if(mobilePanel) mobilePanel.style.display = 'none';
                            document.body.style.overflow = '';
                            exportAllData().catch(e => {
                                alert('Error exportando: ' + e.message);
                                console.error(e);
                            });
                            break;
                        case 'sync':
                            // Sincronizar desde Firebase
                            btn.textContent = '‚è≥ Sincronizando...';
                            btn.disabled = true;
                            loadAllDataFromFirebase().then(() => {
                                alert('‚úÖ Sincronizado');
                                btn.textContent = 'üîÑ\nSincronizar';
                                btn.disabled = false;
                            }).catch(e => {
                                alert('Error: ' + e.message);
                                btn.textContent = 'üîÑ\nSincronizar';
                                btn.disabled = false;
                            });
                            break;
                    }
                });
            });
        }
    });
</script>
</body>